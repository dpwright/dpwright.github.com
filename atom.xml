<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Wright Access</title>
    <link href="http://dpwright.com/atom.xml" rel="self" />
    <link href="http://dpwright.com" />
    <id>http://dpwright.com/atom.xml</id>
    <author>
        <name>Daniel P. Wright</name>
        <email>dani@dpwright.com</email>
    </author>
    <updated>2018-04-06T20:43:00Z</updated>
    <entry>
    <title>Graphical log with vim-fugitive</title>
    <link href="http://dpwright.com/posts/2018/04/06/graphical-log-with-vimfugitive/index.html" />
    <id>http://dpwright.com/posts/2018/04/06/graphical-log-with-vimfugitive/index.html</id>
    <published>2018-04-06T20:43:00Z</published>
    <updated>2018-04-06T20:43:00Z</updated>
    <summary type="html"><![CDATA[

<div class="info"> 6 April, 2018</div>

<p>Tim Pope’s excellent <a href="https://github.com/tpope/vim-fugitive"><code>vim-fugitive</code></a> is the best interface I’ve encountered for working with git. I love using <code>:Gdiff</code> not just to compare changes, but to stage and unstage hunks to the index, looking up the origin of a particular change with <code>:Gblame</code>, and being able to fetch, merge, and commit changes from within the editor.</p>
<p>One feature I miss from other tools, however, is an easy way to browse the history of the repository as a whole, rather than on a file-by-file basis. <code>:Glog</code> loads the history of the current file into the change list, which is a great way to see the changes to that file over time, but the changes are limited to a single file. You can use <code>:Glog --</code> to load the history of the entire repository, but it will still get loaded as a single, flat list, and since it is now much longer it can be quite unwieldy to navigate.</p>
<p>I have long had the following line in my git aliases, which displays a nicely-formatted graph of the repository:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"></code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"><span class="dt">lg </span><span class="ot">=</span><span class="st"> log --graph --pretty=format:&#39;%Cred%h%Creset - %Cgreen(%ad)%C(yellow)%d%Creset %s %C(bold blue)&lt;%an&gt;%Creset&#39; --abbrev-commit --date=local</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>I can’t remember where I originally copied this from. It looks very similar to <a href="https://coderwall.com/p/euwpig/a-better-git-log">this one</a>, although the date is at the start, and absolute rather than relative. Perhaps I customised it. This is the output it produces:</p>
<center>
<img src="/posts/2018/04/06/graphical-log-with-vimfugitive/git-lg.png" title="Output of the git-lg command" />
</center>
<p>I’ve always liked this visualisation, but one problem with it is that it’s pretty static—you just get the list of commits, with no way to “select” a commit and see its contents. For this, I’ve tended to use <a href="https://github.com/jonas/tig"><code>tig</code></a>, or some graphical git client like <code>gitk</code>. I don’t find <code>tig</code> nearly as readable as <code>git lg</code>, though, and having to switch to a whole graphical client just to read the log feels like overkill. And, apart from anything else, what I usually want to do once I’ve <em>found</em> the commit I’m interested in is to edit it in vim!</p>
<p>Well, it turns out it’s easy to get this integrated into vim using fugitive. As a first pass, I simply created a <code>Glg</code> command by adding the following to my <code>.vimrc</code>:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>command -nargs=* Glg Git! log --graph --pretty=format:&#39;\%h - (\%ad)\%d \%s &lt;\%an&gt;&#39; --abbrev-commit --date=local &lt;args&gt;</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>Alternatively if you already have the <code>git lg</code> alias set up in your <code>.gitconfig</code> you can just call that:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>command -nargs=* Glg Git! lg &lt;args&gt;</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>This gives us the graph visualisation we want, but some syntax highlighting would be nice. Fugitive’s <code>:Git!</code> command sets the filetype of the output buffer to <code>git</code>, so I created the file <code>~/.vim/after/syntax/git.vim</code> and added the following highlighting rules to it.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>syn match gitLgLine     </code></pre></td>
<td align="left"><pre><code>/^[_\*|\/\\ ]\+\(\&lt;\x\{4,40\}\&gt;.*\)\?$/</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>syn match gitLgHead     </code></pre></td>
<td align="left"><pre><code>/^[_\*|\/\\ ]\+\(\&lt;\x\{4,40\}\&gt; - ([^)]\+)\( ([^)]\+)\)\? \)\?/ contained containedin=gitLgLine</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>syn match gitLgDate     </code></pre></td>
<td align="left"><pre><code>/(\u\l\l \u\l\l \d\=\d \d\d:\d\d:\d\d \d\d\d\d)/ contained containedin=gitLgHead nextgroup=gitLgRefs skipwhite</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>syn match gitLgRefs     </code></pre></td>
<td align="left"><pre><code>/([^)]*)/ contained containedin=gitLgHead</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>syn match gitLgGraph    </code></pre></td>
<td align="left"><pre><code>/^[_\*|\/\\ ]\+/ contained containedin=gitLgHead,gitLgCommit nextgroup=gitHashAbbrev skipwhite</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>syn match gitLgCommit   </code></pre></td>
<td align="left"><pre><code>/^[^-]\+- / contained containedin=gitLgHead nextgroup=gitLgDate skipwhite</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>syn match gitLgIdentity </code></pre></td>
<td align="left"><pre><code>/&lt;[^&gt;]*&gt;$/ contained containedin=gitLgLine</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>hi def link gitLgGraph    </code></pre></td>
<td align="left"><pre><code>Comment</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>hi def link gitLgDate     </code></pre></td>
<td align="left"><pre><code>gitDate</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>hi def link gitLgRefs     </code></pre></td>
<td align="left"><pre><code>gitReference</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>hi def link gitLgIdentity </code></pre></td>
<td align="left"><pre><code>gitIdentity</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>This is all pretty rudimentary, but it seems to do the job! If you change the format of <code>git lg</code>, these syntax highlighting rules would need to be updated as well. Here’s the end result in action:</p>
<center>
<img src="/posts/2018/04/06/graphical-log-with-vimfugitive/fugitive-lg.gif" title="The :Glg command in action" />
</center>
<p>Because the temporary buffer <code>vim-fugitive</code> creates for the output of <code>:Git!</code> commands is of filetype <code>git</code>, we get some of fugitive’s global shortcuts for free. This allows us to open the commit under the cursor with <code>&lt;C-w&gt;f</code>, and from there inspect the diffs for each file within.</p>
<p>It’s not perfect—some shortcuts are inexplicably unavailable, and it would be nice if <code>&lt;C-w&gt;f</code> worked anywhere in the line, rather than having to move the cursor over the SHA1 hash itself—but it’s pretty good considering how easy it was to set up!</p>

<div class="tagsinfo"><a href="/tags/vim/index.html">vim</a>, <a href="/tags/git/index.html">git</a></div>
]]></summary>
</entry>
<entry>
    <title>Nymphetamine Fix</title>
    <link href="http://dpwright.com/posts/2017/09/04/nymphetamine-fix/index.html" />
    <id>http://dpwright.com/posts/2017/09/04/nymphetamine-fix/index.html</id>
    <published>2017-09-04T13:25:00Z</published>
    <updated>2017-09-04T13:25:00Z</updated>
    <summary type="html"><![CDATA[

<div class="info"> 4 September, 2017</div>

<p>I’ve been on a bit of a Cradle of Filth nostalgia rush recently, so I decided to write an arrangement of their song, <em>Nymphetamine Fix</em>, from the album of (almost) the same name, <em>Nymphetamine</em>. I’m still working on actually being able to <em>play</em> this arrangement, but I have got a MIDI rendering of it you can listen to here:</p>
<center>
<audio src="/posts/2017/09/04/nymphetamine-fix/nymphetamine-fix.mp3" controls />
</center>
<p>I should note that I didn’t just do this by ear (which I’m rubbish at); I made the use of the following resources while I was arranging it:</p>
<ul>
<li><a href="https://www.songsterr.com/a/wsa/cradle-of-filth-nymphetamine-tab-g-s3838">Nymphetamine tab on Songsterr</a>, which I used to get a basic feel for the song, and</li>
<li><a href="https://www.scribd.com/doc/7847913/Cradle-of-Filth-NymphEtaMine-piano">Christine Palethorpe’s piano arrangement</a>, which was especially useful for getting the vocal melodies, as well as some other nice bits which I brazenly stole. There is a <a href="https://www.youtube.com/watch?v=7NaecpN11l8">recording of this piano arrangement on her YouTube channel</a> which is definitely worth checking out.</li>
</ul>
<p>You can download versions engraved in traditional notation, tablature, or both below:</p>
<center>
<a href="/posts/2017/09/04/nymphetamine-fix/nymphetamine-fix.pdf">
<figure style="display: inline-block;">
<img src="/posts/2017/09/04/nymphetamine-fix/both.jpg" alt="Nymphetamine Fix" />
<figcaption>
Traditional and Tab
</figcaption>
</figure>
</a> <a href="/posts/2017/09/04/nymphetamine-fix/nymphetamine-fix-traditional.pdf">
<figure style="display: inline-block;">
<img src="/posts/2017/09/04/nymphetamine-fix/traditional.jpg" alt="Nymphetamine Fix (Traditional Notation)" />
<figcaption>
Traditional Only
</figcaption>
</figure>
</a> <a href="/posts/2017/09/04/nymphetamine-fix/nymphetamine-fix-tab.pdf">
<figure style="display: inline-block;">
<img src="/posts/2017/09/04/nymphetamine-fix/tab.jpg" alt="Nymphetamine Fix (Tablature)" />
<figcaption>
Tablature Only
</figcaption>
</figure>
</a>
</center>
<p>If you aren’t familiar with Cradle of Filth or their song <em>Nymphetamine Fix</em>, here’s the official video. It is a bit louder than the solo guitar version above.</p>
<center>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/6dW6aNAZGTM?rel=0" frameborder="0" style="max-width: 100%" allowfullscreen>
</iframe>
</center>

<div class="tagsinfo"><a href="/tags/guitar/index.html">guitar</a>, <a href="/tags/tablature/index.html">tablature</a>, <a href="/tags/lilypond/index.html">lilypond</a></div>
]]></summary>
</entry>
<entry>
    <title>Station 13 Podcast</title>
    <link href="http://dpwright.com/posts/2017/08/24/station-13-podcast/index.html" />
    <id>http://dpwright.com/posts/2017/08/24/station-13-podcast/index.html</id>
    <published>2017-08-24T06:37:52Z</published>
    <updated>2017-08-24T06:37:52Z</updated>
    <summary type="html"><![CDATA[

<div class="info">24 August, 2017</div>

<p>This site has lain fallow for a little while now, for a number of reasons, not least of which that I found myself in a pit of Cabal Hell which I didn’t get around to digging myself out of for two years. I have now switched the site, and its <code>.travis.yml</code> spec, over to stack, so I’m up and running again, and hopefully I’ll remember to post occasionally!</p>
<p>Anyway, just wanted to take the opportunity to plug one of my new projects, <a href="https://station13.fm">Station 13</a>.</p>
<p>Station 13 is a joint project between me and my good friend and former coworker, <a href="https://twitter.com/ATYPE808">Alex May</a>. We used to catch a train together when we were working in the videogames industry in Kyoto, Japan, and during those journeys we’d talk about anything and everything that caught our interest. We missed those train journeys, so we decided to recreate them, and to record them so anybody else who might be interested could also listen!</p>
<p>It isn’t a programming podcast (Alex is an audio engineer, not a programmer), and it isn’t a podcast about video games or about living in Japan, although we do talk about those things sometimes. It isn’t exclusively a tech podcast either, although given the nature of our shared interests tech topics do tend to come up quite often! Some of the things we’ve talked about so far:</p>
<ul>
<li>Switching from GMail to FastMail</li>
<li>Bitsummit and the Japanese indie games scene</li>
<li>Superhero comics, Greek Mythology, and the Silmarillion</li>
<li>Standing desks and open offices</li>
<li>Security and the benefits of using a password manager</li>
<li>Mechanical watches</li>
<li>What it’s like to work in industrial design</li>
<li>Flying business and first class</li>
</ul>
<p>If this range of topics sounds appealing to you, please subscribe! It should be listed in your favourite podcast player’s directory (<a href="https://twitter.com/danielpwright">please let me know</a> if it isn’t), or you can visit the website below. Thanks!</p>
<center>
<a href="https://station13.fm"><img src="/posts/2017/08/24/station-13-podcast/station-13.jpg" alt="Station 13" /></a>
</center>

<div class="tagsinfo"><a href="/tags/Station%2013/index.html">Station 13</a>, <a href="/tags/podcasts/index.html">podcasts</a></div>
]]></summary>
</entry>
<entry>
    <title>Generating this website part 8</title>
    <link href="http://dpwright.com/posts/2017/08/02/generating-this-website-part-8-crossposting/index.html" />
    <id>http://dpwright.com/posts/2017/08/02/generating-this-website-part-8-crossposting/index.html</id>
    <published>2017-08-02T20:09:00Z</published>
    <updated>2017-08-02T20:09:00Z</updated>
    <summary type="html"><![CDATA[

<div class="info"> 2 August, 2017</div>

<div class="sidenote">
<p>This is part eight of the “generating this website” series. To read the rest of the series, go to the series index <a href="/tags/generating%20this%20website">here</a></p>
</div>
<p>Occasionally (very occasionally in fact – this has only happened once!) I write something which is intended to be cross-posted to another site as well as being hosted on my own. I did this with my post on <a href="/posts/2013/08/21/writing-a-tcp-server-in-haskell-using-proxies-and-pipes">proxies and pipes</a>, which was also pretty much the first bit of Haskell code I put out, and is probably hopelessly outdated by this point, but there it is.</p>
<p>The idea here is that I want to be able to write a post on my site as usual, but also have it uploaded to the site that I’m contributing to. I have another script which deals with uploading the post to WordPress, so all this part of the generator has to do is add a header to the top of the post linking to the other version of the site.</p>
<p>Let’s begin with the standard fluff…</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE UnicodeSyntax #-}</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">Crossposting</span> <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Prelude.Unicode</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Control.Monad.Unicode</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Hakyll</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>All this module really does is expose a function, <code>crosspostField</code>, which returns the content of the header we want to insert at the top of the page if it’s a crosspost. This is fed into the template for <a href="/posts/2014/09/29/generating-this-website-part-2-posts">posts</a>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; crosspostField ::</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Context</span> a</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> crosspostField key <span class="fu">=</span> field key <span class="fu">$</span> getCrosspostHeader key ∘ itemIdentifier</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The idea behind this is to extract the field identified by <code>key</code> from the metadata at the top of the post file, and pass it off to <code>getCrosspostHeader</code> to turn into a header body. The job of this function, then, is to look in the <code>templates/xp/</code> folder for a template file whose name matches the value of the field, render that template if found, and return it – otherwise we return an empty string. This is given below.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; getCrosspostHeader ::</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Identifier</span> <span class="ot">→</span> <span class="dt">Compiler</span> <span class="dt">String</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> getCrosspostHeader key n <span class="fu">=</span> getMetadata n ≫<span class="fu">=</span> toHeader ∘ lookupString key</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span> loadHeader        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> fmap itemBody ∘ header</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         toHeader          </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> maybe (return <span class="st">&quot;&quot;</span>) loadHeader</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         header name       </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> makeItem <span class="st">&quot;&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">≫<span class="fu">=</span> loadAndApplyTemplate (templatePath name) xpContext</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         templatePath name </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> fromFilePath <span class="fu">$</span> <span class="st">&quot;templates/xp/&quot;</span> <span class="fu">++</span> name <span class="fu">++</span> <span class="st">&quot;.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         xpContext         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> defaultContext</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Note that the header itself is a template, rendered using the <code>defaultContext</code> context. This means it has access to other fields in the post’s metadata – useful if you want to link to the other version of the site, as you can put its URL or ID into the metadata.</p>

<div class="tagsinfo"><a href="/tags/hakyll/index.html">hakyll</a>, <a href="/tags/literate-programs/index.html">literate-programs</a>, <a href="/tags/generating%20this%20website/index.html">generating this website</a></div>
]]></summary>
</entry>
<entry>
    <title>Generating this website part 8</title>
    <link href="http://dpwright.com/posts/2017/08/02/generating-this-website-part-8/index.html" />
    <id>http://dpwright.com/posts/2017/08/02/generating-this-website-part-8/index.html</id>
    <published>2017-08-02T20:09:00Z</published>
    <updated>2017-08-02T20:09:00Z</updated>
    <summary type="html"><![CDATA[

<div class="info"> 2 August, 2017</div>

<div class="sidenote">
<p>This is part eight of the “generating this website” series. To read the rest of the series, go to the series index <a href="/tags/generating%20this%20website">here</a></p>
</div>
<p>Occasionally (very occasionally in fact – this has only happened once!) I write something which is intended to be cross-posted to another site as well as being hosted on my own. I did this with my post on <a href="/posts/2013/08/21/writing-a-tcp-server-in-haskell-using-proxies-and-pipes">proxies and pipes</a>, which was also pretty much the first bit of Haskell code I put out, and is probably hopelessly outdated by this point, but there it is.</p>
<p>The idea here is that I want to be able to write a post on my site as usual, but also have it uploaded to the site that I’m contributing to. I have another script which deals with uploading the post to WordPress, so all this part of the generator has to do is add a header to the top of the post linking to the other version of the site.</p>
<p>Let’s begin with the standard fluff…</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE UnicodeSyntax #-}</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">Crossposting</span> <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Prelude.Unicode</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Control.Monad.Unicode</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Hakyll</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>All this module really does is expose a function, <code>crosspostField</code>, which returns the content of the header we want to insert at the top of the page if it’s a crosspost. This is fed into the template for <a href="/posts/2014/09/29/generating-this-website-part-2-posts">posts</a>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; crosspostField ::</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Context</span> a</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> crosspostField key <span class="fu">=</span> field key <span class="fu">$</span> getCrosspostHeader key ∘ itemIdentifier</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The idea behind this is to extract the field identified by <code>key</code> from the metadata at the top of the post file, and pass it off to <code>getCrosspostHeader</code> to turn into a header body. The job of this function, then, is to look in the <code>templates/xp/</code> folder for a template file whose name matches the value of the field, render that template if found, and return it – otherwise we return an empty string. This is given below.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; getCrosspostHeader ::</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Identifier</span> <span class="ot">→</span> <span class="dt">Compiler</span> <span class="dt">String</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> getCrosspostHeader key n <span class="fu">=</span> getMetadata n ≫<span class="fu">=</span> toHeader ∘ lookupString key</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span> loadHeader        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> fmap itemBody ∘ header</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         toHeader          </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> maybe (return <span class="st">&quot;&quot;</span>) loadHeader</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         header name       </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> makeItem <span class="st">&quot;&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">≫<span class="fu">=</span> loadAndApplyTemplate (templatePath name) xpContext</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         templatePath name </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> fromFilePath <span class="fu">$</span> <span class="st">&quot;templates/xp/&quot;</span> <span class="fu">++</span> name <span class="fu">++</span> <span class="st">&quot;.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         xpContext         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> defaultContext</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Note that the header itself is a template, rendered using the <code>defaultContext</code> context. This means it has access to other fields in the post’s metadata – useful if you want to link to the other version of the site, as you can put its URL or ID into the metadata.</p>

<div class="tagsinfo"><a href="/tags/hakyll/index.html">hakyll</a>, <a href="/tags/literate-programs/index.html">literate-programs</a>, <a href="/tags/generating%20this%20website/index.html">generating this website</a></div>
]]></summary>
</entry>
<entry>
    <title>Generating this website part 7</title>
    <link href="http://dpwright.com/posts/2016/01/22/generating-this-website-part-7-slideshows/index.html" />
    <id>http://dpwright.com/posts/2016/01/22/generating-this-website-part-7-slideshows/index.html</id>
    <published>2016-01-22T18:50:00Z</published>
    <updated>2016-01-22T18:50:00Z</updated>
    <summary type="html"><![CDATA[

<div class="info">22 January, 2016</div>

<div class="sidenote">
<p>This is part seven of the “generating this website” series. To read the rest of the series, go to the series index <a href="/tags/generating%20this%20website">here</a></p>
</div>
<p>Occasionally I give talks for which I want to write up an accompanying blog post. Since Pandoc supports various slideshow formats directly, I can actually use the same system both for my blog posts and for writing my slides – in fact, I can use the same source to produce all three: the post, the slides, and any accompanying code – using literate programming!</p>
<p>Of course, this won’t always work. Sometimes, the way you present things in a talk must flow quite differently from the way you present them in a blog post. But this is a limitation of the presentation media, not a technical limitation, and so I’d like to support both formats. Here’s an outline of what we’re going to try and achieve:</p>
<ul>
<li>If the post is in the <code>posts/</code> directory, it will be rendered into a blog post as usual.</li>
<li>If the post has the metadata field <code>slides</code>, it will be processed as a slideshow of the format specified in that field. So, if the <code>slides</code> field contains the string <code>RevealJSSlides</code> then the file will generate a <code>reveal.js</code> slideshow; if it contains <code>S5Slides</code> it will be formatted as S5, and so on. For a full list of supported slideshow formats, see the <a href="https://hackage.haskell.org/package/pandoc-1.13/docs/Text-Pandoc-Options.html#t:HTMLSlideVariant">pandoc documentation</a>.</li>
<li>The slides compiler will search both the <code>posts</code> and <code>slides</code> directories, so that it is possible to generate slides without generating a post.</li>
<li>Any files in the <code>slides/</code> directory which do not contain the ‘slides’ metadata field will default to <code>RevealJSSlides</code></li>
<li>Slides will be output into the <code>slides/</code> directory, regardless of which directory they came from.</li>
<li>If the file extension is <code>.lhs</code>, the file will be treated as literate haskell as usual.</li>
</ul>
<p>All in all, this set of requirements should be fairly simple; the only potentially tricky part is searching for slides using the posts’ metadata rather than their filename, and even that should just come down to quitting out of the compiler early in case the <code>slides</code> field isn’t present.</p>
<h2 id="preliminaries">Preliminaries</h2>
<p>As always, we begin by specifying <code>OverloadedStrings</code> and importing <code>Hakyll</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE UnicodeSyntax #-}</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">Slides</span> <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Control.Monad.Unicode</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Hakyll</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Monoid’s <code>mappend</code> operator is also useful to have.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Monoid</span> ((&lt;&gt;))</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We’ll be making use of a custom pandoc compiler to actually output the slides, so we’ll need to bring the appropriate pandoc options into scope.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Text.Pandoc.Options</span> (</code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">WriterOptions</span> (<span class="fu">..</span>),</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">HTMLSlideVariant</span>(<span class="fu">..</span>))</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>I’m also going to import the <code>Posts</code> module as the compiler I use for generating slideshows will be similar to the one used for generating standard blog posts, so I’ll want to reuse that. Check out the <a href="/posts/2014/09/29/generating-this-website-part-2-posts">post on posts</a> for more information on what’s in this module.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Posts</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="locating-slideshow-files">Locating slideshow files</h2>
<p>The first step is to create some Hakyll <code>Rules</code> specifying which files to match and where to put them. The requirements outlined above essentially specify two alternatives:</p>
<ul>
<li>Files in the <code>posts</code> directory which <em>must</em> contain the <code>slides</code> metadata field (otherwise they won’t be recognised as slideshows).</li>
<li>Files in the <code>slides</code> directory which <em>may</em> contain a <code>slides</code> field (and if not default to <code>RevealJSSlides</code>).</li>
</ul>
<p>The easiest of the two is the latter – just match the files and compile them.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slideshows ::</span> <span class="dt">Rules</span> ()</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slideshows <span class="fu">=</span> match <span class="st">&quot;slides/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   route <span class="fu">$</span> setExtension <span class="st">&quot;.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   compileSlideshow</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Picking out those posts which contain a <code>slides</code> metadata field requires the <code>matchMetadata</code> function which was introduced in hakyll 4.6.4.0. We use <code>version</code> to keep slides distinct from normal posts, allowing both to be built and preventing slideshows from being indexed. After that, we compile the slideshow as above.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slideshowPosts ::</span> <span class="dt">Rules</span> ()</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slideshowPosts <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   matchMetadata <span class="st">&quot;posts/*&quot;</span> isSlideshow <span class="fu">.</span> version <span class="st">&quot;slideshow&quot;</span> <span class="fu">$</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">do</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">route <span class="fu">$</span> setExtension <span class="st">&quot;.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">compileSlideshow</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     isSlideshow <span class="fu">=</span> maybe <span class="dt">False</span> (const <span class="dt">True</span>) <span class="fu">.</span> lookupString <span class="st">&quot;slides&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The <code>compileSlideshow</code> rule extracts the <code>slides</code> metadata in order to decide which type of slideshow to generate, then passes it to <code>slidesCompiler</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; compileSlideshow ::</span> <span class="dt">Rules</span> ()</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> compileSlideshow <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   compile <span class="fu">$</span> getUnderlying</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ≫<span class="fu">=</span> (<span class="ot">`getMetadataField`</span> <span class="st">&quot;slides&quot;</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ≫<span class="fu">=</span> slidesCompiler <span class="fu">.</span> maybe <span class="dt">SlidySlides</span> read</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ≫<span class="fu">=</span> relativizeUrls</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="generating-the-slideshows">Generating the slideshows</h2>
<p>Now that we know which files we should be creating slideshows for, we’re ready to do the actual generation! As usual, we start with the context, which is very simple – just attach a date to the default context.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesCtx ::</span> <span class="dt">Context</span> <span class="dt">String</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesCtx </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">dateField <span class="st">&quot;date&quot;</span> <span class="st">&quot;%e %B, %Y&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>          </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">&lt;&gt;</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">defaultContext</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Pandoc supports a variety of different slideshow formats, and I haven’t settled on one in particular, so I’ll add support for them individually as I try them out. Each slideshow engine requires a different template, so we’ll make a quick lookup for that.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesTemplate ::</span> <span class="dt">HTMLSlideVariant</span> <span class="ot">→</span> <span class="dt">Identifier</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate <span class="dt">RevealJsSlides</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;templates/slides/reveal.js.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate <span class="dt">S5Slides</span>       </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;templates/slides/s5.html&quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate <span class="dt">SlidySlides</span>    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;templates/slides/slidy.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate s              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> error <span class="fu">$</span> <span class="st">&quot;Unsupported slide variant: &quot;</span> <span class="fu">++</span> show s</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The final clause covers the case where I haven’t yet added support for one of Pandoc’s supported slideshow formats.</p>
<p>Another difference between the various HTML slideshow engines is which HTML they expect to be working with! Reveal.js expects HTML 5, while the others I’ve tried all work better with HTML 4 source. I’ve made a quick lookup for that as well.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesExpectHTML5 ::</span> <span class="dt">HTMLSlideVariant</span> <span class="ot">→</span> <span class="dt">Bool</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesExpectHTML5 <span class="dt">RevealJsSlides</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">True</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesExpectHTML5 _              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">False</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Finally, the compiler itself! This takes a standard pandoc compiler, adds the <code>readerOptions</code> and <code>writerOptions</code> we defined in the entry on standard <a href="/posts/2014/09/29/generating-this-website-part-2-posts">posts</a>, and then customizes them with slideshow-specific functionality.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesCompiler ::</span> <span class="dt">HTMLSlideVariant</span> <span class="ot">→</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesCompiler sv <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   pandocCompilerWith readerOptions slideWriterOpts</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ≫<span class="fu">=</span> loadAndApplyTemplate (slidesTemplate sv) slidesCtx</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     slideWriterOpts </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> writerOptions</code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">{ writerSlideVariant </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> sv</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, writerHtml5        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> slidesExpectHTML5 sv</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, writerIncremental  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">True</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">}</code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="added-extras">Added extras</h2>
<p>That’s really all there is to it on the Hakyll side! To make writing slides and blog posts in the same file easier, I have a couple of CSS <code>div</code> classes set up in the slideshow style files – for instance, anything inside a <code>&lt;div class=&quot;notes&quot;&gt;</code> will be shown in the blog post but not in the slideshow. I have yet to add the reverse functionality but I can’t imagine it would be too difficult. All that can be done with a bit of CSS cleverness, though, with no special support from Hakyll itself.</p>

<div class="tagsinfo"><a href="/tags/hakyll/index.html">hakyll</a>, <a href="/tags/literate-programs/index.html">literate-programs</a>, <a href="/tags/generating%20this%20website/index.html">generating this website</a></div>
]]></summary>
</entry>
<entry>
    <title>Generating this website part 7</title>
    <link href="http://dpwright.com/posts/2016/01/22/generating-this-website-part-7/index.html" />
    <id>http://dpwright.com/posts/2016/01/22/generating-this-website-part-7/index.html</id>
    <published>2016-01-22T18:50:00Z</published>
    <updated>2016-01-22T18:50:00Z</updated>
    <summary type="html"><![CDATA[

<div class="info">22 January, 2016</div>

<div class="sidenote">
<p>This is part seven of the “generating this website” series. To read the rest of the series, go to the series index <a href="/tags/generating%20this%20website">here</a></p>
</div>
<p>Occasionally I give talks for which I want to write up an accompanying blog post. Since Pandoc supports various slideshow formats directly, I can actually use the same system both for my blog posts and for writing my slides – in fact, I can use the same source to produce all three: the post, the slides, and any accompanying code – using literate programming!</p>
<p>Of course, this won’t always work. Sometimes, the way you present things in a talk must flow quite differently from the way you present them in a blog post. But this is a limitation of the presentation media, not a technical limitation, and so I’d like to support both formats. Here’s an outline of what we’re going to try and achieve:</p>
<ul>
<li>If the post is in the <code>posts/</code> directory, it will be rendered into a blog post as usual.</li>
<li>If the post has the metadata field <code>slides</code>, it will be processed as a slideshow of the format specified in that field. So, if the <code>slides</code> field contains the string <code>RevealJSSlides</code> then the file will generate a <code>reveal.js</code> slideshow; if it contains <code>S5Slides</code> it will be formatted as S5, and so on. For a full list of supported slideshow formats, see the <a href="https://hackage.haskell.org/package/pandoc-1.13/docs/Text-Pandoc-Options.html#t:HTMLSlideVariant">pandoc documentation</a>.</li>
<li>The slides compiler will search both the <code>posts</code> and <code>slides</code> directories, so that it is possible to generate slides without generating a post.</li>
<li>Any files in the <code>slides/</code> directory which do not contain the ‘slides’ metadata field will default to <code>RevealJSSlides</code></li>
<li>Slides will be output into the <code>slides/</code> directory, regardless of which directory they came from.</li>
<li>If the file extension is <code>.lhs</code>, the file will be treated as literate haskell as usual.</li>
</ul>
<p>All in all, this set of requirements should be fairly simple; the only potentially tricky part is searching for slides using the posts’ metadata rather than their filename, and even that should just come down to quitting out of the compiler early in case the <code>slides</code> field isn’t present.</p>
<h2 id="preliminaries">Preliminaries</h2>
<p>As always, we begin by specifying <code>OverloadedStrings</code> and importing <code>Hakyll</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE UnicodeSyntax #-}</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">Slides</span> <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Control.Monad.Unicode</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Hakyll</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Monoid’s <code>mappend</code> operator is also useful to have.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Monoid</span> ((&lt;&gt;))</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We’ll be making use of a custom pandoc compiler to actually output the slides, so we’ll need to bring the appropriate pandoc options into scope.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Text.Pandoc.Options</span> (</code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">WriterOptions</span> (<span class="fu">..</span>),</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">HTMLSlideVariant</span>(<span class="fu">..</span>))</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>I’m also going to import the <code>Posts</code> module as the compiler I use for generating slideshows will be similar to the one used for generating standard blog posts, so I’ll want to reuse that. Check out the <a href="/posts/2014/09/29/generating-this-website-part-2-posts">post on posts</a> for more information on what’s in this module.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Posts</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="locating-slideshow-files">Locating slideshow files</h2>
<p>The first step is to create some Hakyll <code>Rules</code> specifying which files to match and where to put them. The requirements outlined above essentially specify two alternatives:</p>
<ul>
<li>Files in the <code>posts</code> directory which <em>must</em> contain the <code>slides</code> metadata field (otherwise they won’t be recognised as slideshows).</li>
<li>Files in the <code>slides</code> directory which <em>may</em> contain a <code>slides</code> field (and if not default to <code>RevealJSSlides</code>).</li>
</ul>
<p>The easiest of the two is the latter – just match the files and compile them.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slideshows ::</span> <span class="dt">Rules</span> ()</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slideshows <span class="fu">=</span> match <span class="st">&quot;slides/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   route <span class="fu">$</span> setExtension <span class="st">&quot;.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   compileSlideshow</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Picking out those posts which contain a <code>slides</code> metadata field requires the <code>matchMetadata</code> function which was introduced in hakyll 4.6.4.0. We use <code>version</code> to keep slides distinct from normal posts, allowing both to be built and preventing slideshows from being indexed. After that, we compile the slideshow as above.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slideshowPosts ::</span> <span class="dt">Rules</span> ()</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slideshowPosts <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   matchMetadata <span class="st">&quot;posts/*&quot;</span> isSlideshow <span class="fu">.</span> version <span class="st">&quot;slideshow&quot;</span> <span class="fu">$</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">do</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">route <span class="fu">$</span> setExtension <span class="st">&quot;.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">compileSlideshow</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     isSlideshow <span class="fu">=</span> maybe <span class="dt">False</span> (const <span class="dt">True</span>) <span class="fu">.</span> lookupString <span class="st">&quot;slides&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The <code>compileSlideshow</code> rule extracts the <code>slides</code> metadata in order to decide which type of slideshow to generate, then passes it to <code>slidesCompiler</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; compileSlideshow ::</span> <span class="dt">Rules</span> ()</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> compileSlideshow <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   compile <span class="fu">$</span> getUnderlying</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ≫<span class="fu">=</span> (<span class="ot">`getMetadataField`</span> <span class="st">&quot;slides&quot;</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ≫<span class="fu">=</span> slidesCompiler <span class="fu">.</span> maybe <span class="dt">SlidySlides</span> read</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ≫<span class="fu">=</span> relativizeUrls</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="generating-the-slideshows">Generating the slideshows</h2>
<p>Now that we know which files we should be creating slideshows for, we’re ready to do the actual generation! As usual, we start with the context, which is very simple – just attach a date to the default context.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesCtx ::</span> <span class="dt">Context</span> <span class="dt">String</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesCtx </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">dateField <span class="st">&quot;date&quot;</span> <span class="st">&quot;%e %B, %Y&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>          </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">&lt;&gt;</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">defaultContext</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Pandoc supports a variety of different slideshow formats, and I haven’t settled on one in particular, so I’ll add support for them individually as I try them out. Each slideshow engine requires a different template, so we’ll make a quick lookup for that.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesTemplate ::</span> <span class="dt">HTMLSlideVariant</span> <span class="ot">→</span> <span class="dt">Identifier</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate <span class="dt">RevealJsSlides</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;templates/slides/reveal.js.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate <span class="dt">S5Slides</span>       </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;templates/slides/s5.html&quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate <span class="dt">SlidySlides</span>    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;templates/slides/slidy.html&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesTemplate s              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> error <span class="fu">$</span> <span class="st">&quot;Unsupported slide variant: &quot;</span> <span class="fu">++</span> show s</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The final clause covers the case where I haven’t yet added support for one of Pandoc’s supported slideshow formats.</p>
<p>Another difference between the various HTML slideshow engines is which HTML they expect to be working with! Reveal.js expects HTML 5, while the others I’ve tried all work better with HTML 4 source. I’ve made a quick lookup for that as well.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesExpectHTML5 ::</span> <span class="dt">HTMLSlideVariant</span> <span class="ot">→</span> <span class="dt">Bool</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesExpectHTML5 <span class="dt">RevealJsSlides</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">True</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesExpectHTML5 _              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">False</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Finally, the compiler itself! This takes a standard pandoc compiler, adds the <code>readerOptions</code> and <code>writerOptions</code> we defined in the entry on standard <a href="/posts/2014/09/29/generating-this-website-part-2-posts">posts</a>, and then customizes them with slideshow-specific functionality.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; slidesCompiler ::</span> <span class="dt">HTMLSlideVariant</span> <span class="ot">→</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> slidesCompiler sv <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   pandocCompilerWith readerOptions slideWriterOpts</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ≫<span class="fu">=</span> loadAndApplyTemplate (slidesTemplate sv) slidesCtx</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     slideWriterOpts </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> writerOptions</code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">{ writerSlideVariant </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> sv</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, writerHtml5        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> slidesExpectHTML5 sv</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, writerIncremental  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">True</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">}</code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="added-extras">Added extras</h2>
<p>That’s really all there is to it on the Hakyll side! To make writing slides and blog posts in the same file easier, I have a couple of CSS <code>div</code> classes set up in the slideshow style files – for instance, anything inside a <code>&lt;div class=&quot;notes&quot;&gt;</code> will be shown in the blog post but not in the slideshow. I have yet to add the reverse functionality but I can’t imagine it would be too difficult. All that can be done with a bit of CSS cleverness, though, with no special support from Hakyll itself.</p>

<div class="tagsinfo"><a href="/tags/hakyll/index.html">hakyll</a>, <a href="/tags/literate-programs/index.html">literate-programs</a>, <a href="/tags/generating%20this%20website/index.html">generating this website</a></div>
]]></summary>
</entry>
<entry>
    <title>Writing a ZX Spectrum game in Haskell</title>
    <link href="http://dpwright.com/posts/2015/07/17/writing-a-zx-spectrum-game-in-haskell/index.html" />
    <id>http://dpwright.com/posts/2015/07/17/writing-a-zx-spectrum-game-in-haskell/index.html</id>
    <published>2015-07-17T08:41:23Z</published>
    <updated>2015-07-17T08:41:23Z</updated>
    <summary type="html"><![CDATA[

<div class="info">17 July, 2015</div>

<p>Haskell, <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/07/mark.pdf">the world’s finest imperative programming language</a>, can now be used to write games for the ZX Spectrum, the world’s finest 80s microcomputer. This post introduces the two packages that make this possible:</p>
<ul>
<li><a href="https://github.com/dpwright/z80">z80</a>, a fully-functional Z80 macro-assembler embedded in Haskell, and</li>
<li><a href="https://github.com/dpwright/zxspectrum">zxspectrum</a>, a set of utilities and macros to make working with the ZX Spectrum specifically easier, including labels for important routines in the Spectrum 48k ROM.</li>
</ul>
<p>These packages wouldn’t have been possible without Russell O’Connor’s excellent article in <a href="https://wiki.haskell.org/wikiupload/1/14/TMR-Issue6.pdf">The Monad.Reader Issue 6</a>, “Assembly: Circular Programming with Recursive do”, which was the main inspiration both for those packages and for this post.</p>
<div class="sidenote">
<p><strong>Warning</strong> Before clicking on the link to load the game below, you should know that I’ve heard reports that on some platforms the JavaScript emulator I’m using to embed it causes a loud, unpleasant noise. I’ve had one report from someone using an Android device and one from somebody using Firefox (not sure on what platform). I’ve tested the page in Safari and it’s fine, but if you’re not using that you might want to turn off your speakers before clicking, or just download the file to play in an emulator. Sorry!</p>
</div>
<p><a href="/pages/lambdaman">Here’s the game we’re going to be making</a>. It’s basically a port of the project pursued over the course of <a href="https://chuntey.wordpress.com/2012/12/18/how-to-write-zx-spectrum-games-chapter-1/">this great set of ZX Spectrum tutorials</a>, which itself is a clone of the game centipede. You can play it directly on this webpage, or you can download the <code>.tap</code> file for playing in an emulator <a href="lambdaman.tap">here</a>.</p>
<p>I made some of my own customisations along the way, but credit for most of the actual assembly code must go to those tutorials, which were an excellent resource for me while I was testing these packages too. Thanks!</p>
<p>OK, without further ado, let’s get started! This is a literate Haskell post, so when it is executed the lines prefixed with <code>&gt;</code> are compiled and run, and the .tap file which is embedded above is generated.</p>
<h2 id="preliminaries">Preliminaries</h2>
<p>The initial pragmas and imports to most <code>zxspectrum</code> projects in Haskell will look similar to this. Firstly, we need the following language extensions:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE RecursiveDo #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>OverloadedStrings</code>, as always, is just a convenience – but a very useful one as any strings you want to print to the ZX Spectrum screen are bytestrings, so it’s nice just to be able to input them as strings. <code>RecursiveDo</code> allows us to define labels after they are used, i.e. to jump to code which comes later in the file – a common idiom in assembly programming.</p>
<p>The following language pragma and import are optional – they give us access to Unicode symbols which I think happen to look nicer on this blog.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE UnicodeSyntax #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Prelude.Unicode</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Now we can move onto the imports. Of course the two most common imports give us the assembler itself and speccy utilities:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Z80</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">ZXSpectrum</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The <a href="https://github.com/dpwright/z80">z80 package</a> tries to define an assembler as close as possible to the original Z80 assembly language – some of the syntactic differences I will cover in a moment – but the result of this is that some names from the Prelude are overloaded. Here we hide those names so we don’t get clashes. If you really need access to the original functions, you can always re-import the Prelude qualified.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Prelude</span>   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">hiding (and, or)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Bits</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">hiding (xor, bit)</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We don’t actually use anything from <em><code>Data.Bits</code></em> in this tutorial, so the import is redundant in this case – I include it here so you can see all the names you may have to hide when you make these standard imports.</p>
<p>Finally we import <em><code>Data.ByteString</code></em> so that we can do things like test the length of strings we embed into our program.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import qualified</span> <span class="dt">Data.ByteString</span> <span class="kw">as</span> <span class="dt">BS</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This particular program will all be embedded within a single <code>main</code> function, however it does make use of one Haskell datatype, which we use in a code-generating macro. Types can’t be defined inline, so let’s define it up here so we can use it later.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">data</span> <span class="dt">Direction</span> <span class="fu">=</span> <span class="dt">DUp</span> <span class="fu">|</span> <span class="dt">DDown</span> <span class="fu">|</span> <span class="dt">DLeft</span> <span class="fu">|</span> <span class="dt">DRight</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>For convenience, I’m also going to put the title screen into a global constant since it’s rather a long filename. You can download the title screen (a result of my unparalleled skill in art, as I’m sure you’ll agree), <a href="lvtc.scr">here</a>. You’ll need a ZX Spectrum SCR viewer to view it, though.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> titleScreen <span class="fu">=</span> <span class="st">&quot;static/posts/2015/07/17/writing-a-zx-spectrum-game-in-haskell/lvtc.scr&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="main-function-and-static-data"><code>main</code> function and static data</h2>
<p>The first line of our program proper sets off the assembler on the rest of the code.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> main <span class="fu">=</span> defaultMain <span class="st">&quot;lambdaman&quot;</span> titleScreen <span class="fu">.</span> org <span class="bn">0x6000</span> <span class="fu">$</span> mdo</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>defaultMain</code> is provided by the <a href="https://github.com/dpwright/zxspectrum">zxspectrum</a> package and right now is fairly unsophisticated: it takes the name of the program, the filename of its loading screen (in the ZX Spectrum standard <code>.scr</code> format), and an <code>ASMBlock</code>, and outputs (as a side effect) a <code>.tap</code> file ready to load in an emulator. Future versions may include some command-line parsing so things like the loading screen are optional, but for now it’s very simple.</p>
<p>The <code>z80</code> package provides a type called <code>Z80</code> which represents the state of the assembler – the functions representing Z80 instruction code form an EDSL inside this monad. To get from a <code>Z80</code> to an <code>ASMBlock</code>, you need to pass it to <code>org</code>, which will set the origin location, from which all further labels are offset. This is slightly different from standard assembler, where <code>org</code> was just an assembler directive which could be called at any time.</p>
<p>Finally the <code>mdo</code> above opens a <code>RecursiveDo</code> block. If you’re not familiar with Recursive Do, it’s basically the same as <code>do</code> except that you can use values before they are defined.</p>
<p>The loader code generated by <code>defaultMain</code> will, by default, assume that the entry point to your application matches the first line of assembly – i.e. the address you pass to <code>org</code>. However, we often want to define a block of static data that we will modify in our program first, and begin execution after this. This is made possible by the <code>beginExecution</code> directive, which sets the entry point to the address at which it is called. It may be used at most once in a program, and if it is never used the entry point is assumed to be at the start.</p>
<p>This is what allows us to define the following data without worrying about the Spectrum trying to execute it!</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">let</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">lambdamanScoreText </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;lambdaman &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">centipedeScoreText </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot; centipede&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   lmName </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb lambdamanScoreText</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   cpName </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb centipedeScoreText</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Here <code>lambdamanScoreText</code> is a <em>Haskell</em> variable which we use immediately below to define <code>lmName</code>, an area of memory in our output binary containing the value in <code>lambdamanScoreText</code>. We do this because later we will want to query it for its length, so it is useful to store it in a variable rather than using a literal. The same goes for the centipede. These represent the labels which appear at the bottom of the screen.</p>
<p>Note the use of the <code>labelled</code> directive, which simply returns the location of the thing you define in its argument. For reference, here’s what this would look like in standard assembler:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>lmName: defb &quot;lambdaman &quot;</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>cpName: defb &quot; centipede&quot;</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>The Haskell is a bit more verbose here, but we make up for that later with its macro-defining power. Onwards!</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   plx  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="dv">0</span>]    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- player&#39;s x coordinate.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ply  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="dv">0</span>]    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- player&#39;s y coordinate.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   pbx  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="bn">0xff</span>] </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- player&#39;s bullet coordinates.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   pby  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="bn">0xff</span>]</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   dead </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="dv">0</span>]    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- flag - player dead when non-0.</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Here we define the state relating to the player. <code>plx</code> and <code>ply</code> represent the player’s own co-ordinates, while <code>pbx</code> and <code>pby</code> represent the co-ordinates of the bullet the player fires. <code>dead</code> simply tells us if the player has been killed.</p>
<div class="sidenote">
<p>The original tutorials on which this is based swap the <em>x</em> and the <em>y</em> co-ordinates, so that <em>x</em> describes how far down the screen we are and <em>y</em> how far across. I found this too confusing, so I have a more traditional co-ordinate system here where <em>x</em> is horizontal, <em>y</em> is vertical, and the origin is at the top-left of the screen.</p>
</div>
<p>Another syntactic difference here is the use of Haskell list notation when passed to <code>defb</code>. <code>defb</code> takes either a <code>ByteString</code> or a list of <code>Word8</code>s, and puts the values into the final binary file as-is.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   lambdamanScore </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="dv">0</span>, <span class="dv">0</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   centipedeScore </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="dv">0</span>, <span class="dv">0</span>]</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Fairly obviously, here we keep track of the scores.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="co">-- Table of segments.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="co">-- Format: 3 bytes per entry, 10 segments.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="co">-- byte 1: 255=segment off, 0=left, 1=right.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="co">-- byte 2 = x (vertical) coordinate.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="co">-- byte 3 = y (horizontal) coordinate.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">let</span> numseg <span class="fu">=</span> <span class="dv">10</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segmnt   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb (replicate (fromIntegral numseg <span class="fu">*</span> <span class="dv">3</span>) <span class="dv">0</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segsLeft </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">←</span> labelled <span class="fu">$</span> defb [numseg]</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Here we set up some space for the centipede segments. The comments describe the format – the co-ordinates of that segment and whether it is going left or right (or has already been destroyed).</p>
<h2 id="user-defined-graphics">User-Defined Graphics</h2>
<p>Finally, let’s define our “assets” – graphic and sound data that will be used in the game. Back in the day, this is how you used to define new graphics for the ZX Spectrum:</p>
<center>
<img src="udg.png" />
</center>
<p>The <a href="https://github.com/dpwright/zxspectrum">zxspectrum</a> package defines a macro called <code>udg</code> which can perform this calculation for you. We use it here to define our four main single-charater sprites:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   udgs <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     udg </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; ss     &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   s    &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   s    &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;  s s   &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; s   s  &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; s    s &quot;</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     udg </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;  ssss  &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; ssssss &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     udg </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;  ssss  &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; ssssss &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; ssssss &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;  ssss  &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;        &quot;</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     udg </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;   ss   &quot;</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;  ssss  &quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot; s ss s &quot;</span>]</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>As you can see we take a list of 8 strings, each 8 characters long. Each space is considered “off”, while anything else (here I use the <code>s</code> character) is “on”. From this we can automatically generate the bytes representing that character.</p>
<p>These UDGs are defined one after another in memory. In a moment, we’ll put the location of the beginning of this block of memory in the special memory address <em><code>UDG_LOC</code></em>, which will tell the Spectrum ROM to look here when printing UDG characters.</p>
<h2 id="sound-effects">Sound Effects</h2>
<p>Sound on the ZX Spectrum – at least the original 48K version – is handled through the use of a simple square-wave beeper which can be set to oscillate at a certain frequency for a certain length of time (during which execution is blocked). As such sound effects are less “data” than they are functions which you call, setting the appropriate registers and executing the ROM routines which cause the beeper to oscillate (appropriately named <em><code>BEEPER</code></em>).</p>
<p>However, the <a href="https://github.com/dpwright/zxspectrum">zxspectrum</a> package provides a couple of macros to help with this. The one we use here, <code>playSeq</code>, takes a list of pairs specifying notes and their durations, and generates a function which will play the notes in sequence. Execution is blocked, so for in-game sound effects we have to keep them fairly short so they don’t interfere with gameplay too much. The sound effects below were designed and tracked by my good friend <a href="https://twitter.com/atype808">Alex May</a>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   sfxStart <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span> <span class="co">-- Start game</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     playSeq </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ (note <span class="dt">F_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.111</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">AS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.222</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">C_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.111</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">D_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.222</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">C_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.111</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">AS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.222</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">F_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">1.000</span>) ]</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   sfxHitC  <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span> <span class="co">-- Hit centipede segment</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     playSeq </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ (note <span class="dt">E_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.033</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">G_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.033</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">C_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.066</span>) ]</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   sfxHitM  <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span> <span class="co">-- Hit mushroom</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     playSeq </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ (note <span class="dt">F_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">3</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.033</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">FS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">3</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.033</span>) ]</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   sfxLost  <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span> <span class="co">-- Lambdaman died</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     playSeq </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ (note <span class="dt">GS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">C_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">A_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">B_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">GS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">AS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">G_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">A_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">FS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">GS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">F_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">G_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.083</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">E_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.748</span>) ]</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   sfxWon   <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span> <span class="co">-- Centipede died</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     playSeq </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ (note <span class="dt">G_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.222</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">F_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.111</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">D_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.222</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">C_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.111</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">D_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.222</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">F_</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.333</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">, (note <span class="dt">AS_</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span>, </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fl">0.777</span>) ]</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The comments describe what each effect does. <code>sfxHitC</code> and <code>sfxHitM</code> are both run during gameplay, so they have been kept short and sweet. The other effects happen at a point where the game is halted for some reason anyway, so we can afford to play something longer.</p>
<p>Since these are functions and not really data, of course, they must end with <code>ret</code> to return exeution to whatever called them – otherwise the program counter will just keep on running past them!</p>
<p>Our “data” defined, we are now ready to start the game. We tell <code>z80</code> to set the entry point for the program here:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   beginExecution</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="z80-syntax"><code>z80</code> syntax</h2>
<p>Before we get too heavily into the code, I’d like to say a brief word about the differences in syntax between traditional Z80 assembly code and the embedded assembler exposed by the <a href="https://github.com/dpwright/z80">z80</a> package.</p>
<p>As far as possible I’ve tried to keep the two very similar. The names of all operations are identical, with the exception of <code>in</code> which is a keyword in Haskell, so I have had to rename it to <code>in_</code>. Other than that, there are just a few differences to bear in mind if you are already familiar with Z80 assembly and you’d like to start using the Haskell z80 package:</p>
<ol style="list-style-type: decimal">
<li>Operands are separated by spaces, not commas, as per Haskell function syntax. Sometimes this means you have to surround expressions in parentheses where none would be required in z80asm. This is OK though, because,</li>
<li>Pointer dereferencing is done using square brackets <code>[]</code> instead of round parentheses <code>()</code>, as there is no sensible way to detect the presence or absence of the latter in Haskell. Instead, I hijack list syntax to represent dereferencing. Using the empty list or a list with more than one entry obviously won’t work here, so… don’t do that.</li>
<li>Traditionally z80asm is case-insensitive. Haskell is not. Personally, I find having a separate namespace (i.e. capital letters) for registers and ROM memory locations to be useful, but if you want to be able to use lower-case labels for your registers (<code>ld a 4</code> as opposed to <code>ld A 4</code>) you can; just add <code>import Z80.Operands.LowerCase</code> to the top of the file.</li>
<li>z80asm has one way to define labels: put a string with a colon at the end in the first column. <a href="https://github.com/dpwright/z80">z80</a> has three: As well as the <code>labelled</code> directive you’ve already seen, there’s also <code>label</code>, which is the closest equivalent to a standard labelling mechanism, and <code>withLabel</code> which introduces a <em>scoped</em> label; allowing you to use the same name for multiple labels in your program (useful for loops and such!)</li>
</ol>
<p>That’s about it – everything else falls naturally out of standard Haskell syntax. As we go on, I may show some examples of the two side-by-side so you can get a better idea.</p>
<h2 id="initialisation">Initialisation</h2>
<p>There are two simple bits of initialisation we’ll do once before the game starts, and then never need to touch again. The first is to set up the UDG location to print our “sprites”, and the second is to play the “game start” sound which will alert the user that the game has finished loading and they should get ready to play.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ldVia <span class="dt">HL</span> [<span class="dt">UDG_LOC</span>] udgs</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call sfxStart</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>ldVia</code>, as you will have guessed, is not standard z80 assembler. It is probably the simplest example of a macro, abstracting the common pair of operations:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">       ld <span class="dt">HL</span> udgs</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">       ld [<span class="dt">UDG_LOC</span>] <span class="dt">HL</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This is because you can’t just arbitrarily load a number into memory; you have to load it into a register first and then load it from that register into the memory area you wanted. <code>ldVia</code> is so common that I have included it in the <a href="https://github.com/dpwright/z80">z80</a> package so you can use it out of the box.</p>
<div class="sidenote">
<p><code>ldVia</code> also gives us a nice example of how, by using Haskell, we can make our macros ‘type-safe’. Here’s its type signature:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">ldVia ::</span> (<span class="dt">Load</span> a c, <span class="dt">Load</span> b a) <span class="ot">⇒</span> a <span class="ot">→</span> b <span class="ot">→</span> c <span class="ot">→</span> <span class="dt">Z80ASM</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>What this says is, “given an <code>a</code> that can be loaded into from <code>c</code>, and a <code>b</code> that can be loaded into from <code>a</code>, as well as the initial <code>c</code>, produce the assembly code to load <code>c</code> into <code>a</code> and then load that <code>a</code> into <code>b</code>”. <em><code>Z80ASM</code></em> is just a type alias for <em><code>Z80 ()</code></em>.</p>
<p>Whether this form of type-safety is actually <em>useful</em> is up for debate. With a traditional macro assembler, the macro would just be expanded and then assembly would fail from there. And the type gymnastics I had to do to make this look like Z80 assembler mean that the error messages when you get it wrong can be less than useful. But it’s interesting! And the type signatures are still useful, if just as documentation.</p>
</div>
<p>After that, we play the intro sound by just calling the function we defined above to play it.</p>
<h2 id="setting-up-the-play-area">Setting up the play area</h2>
<p>That sets us up ready to start the game – the next step is to clear the screen (it currently has the loading screen on it) and set up the play area. We’ll do this between each round of the game, so let’s make a label we can jump back to when the player wins or loses.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   gameStart <span class="ot">←</span> label</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The first step is to set up our default colours and clear the screen to those colours. This is accomplished using a couple of helper functions from the <a href="https://github.com/dpwright/zxspectrum">zxspectrum</a> package.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   setBorderColour <span class="dt">Black</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   setAttrs <span class="dt">AttrDefault</span> <span class="dt">NoFlash</span> <span class="dt">Bright</span> (<span class="dt">Paper</span> <span class="dt">Black</span>) (<span class="dt">Ink</span> <span class="dt">White</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call <span class="dt">CL_ALL</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The first two lines here are just macros which poke the appropriate data into the right bit of memory based on their parameters. The last line calls the <em><code>CL_ALL</code></em> routine, which is defined in the Spectrum ROM and clears the entire screen.</p>
<p>Next, let’s write the scores on the screen. This is a bit of a diversion from traditional centipede; in this game you are battling against the centipede to see who can destroy their opponent the most times (spoiler: it’s probably the centipede). Every time you play, either lambdaman gets hit and dies, incrementing the centipede’s score counter, or lambdaman destroys all ten of the centipede’s segments, incrementing the lambdaman score counter. Since scores are only modified between rounds we can get away with rendering them once at the beginning of the round and then leaving them untouched, rather than re-rendering them every frame, which will save us precious cycles.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">A</span> <span class="dv">2</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call <span class="dt">CHAN_OPEN</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   setCursorPos (<span class="dv">0</span>, <span class="dv">21</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   </code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">DE</span> lmName</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">BC</span> <span class="fu">.</span> fromIntegral <span class="fu">$</span> BS.length lambdamanScoreText</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call <span class="dt">PR_STRING</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">BC</span> [lambdamanScore]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call <span class="dt">OUT_NUM_1</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   </code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">let</span> centipedeScoreStartX <span class="fu">=</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         fromIntegral <span class="fu">$</span> <span class="dv">31</span> <span class="fu">-</span> <span class="dv">3</span> <span class="fu">-</span> BS.length centipedeScoreText</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   setCursorPos (centipedeScoreStartX, <span class="dv">21</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">HL</span> centipedeScore</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call <span class="dt">OUT_NUM_2</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">DE</span> cpName</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">BC</span> <span class="fu">.</span> fromIntegral <span class="fu">$</span> BS.length centipedeScoreText</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   call <span class="dt">PR_STRING</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We make use of a number of standard Spectrum ROM routines to accomplish this. <em><code>PR_STRING</code></em> prints a string formed by taking the address stored in the <em><code>DE</code></em> register, and <em>n</em> bytes after that, where <em>n</em> is the number stored in the <em><code>BC</code></em> register.</p>
<p><em><code>OUT_NUM_1</code></em> and <em><code>OUT_NUM_2</code></em> are both for printing numbers; the former prints the number in the <em><code>BC</code></em> register, while the latter uses the <em><code>HL</code></em> register and, more importantly, right-aligns the number.</p>
<p>All this faffing about with what registers are used for what should convince you that just because we are writing Haskell, we are not writing high-level code here. This is still bona-fide z80 assembler; the Haskell is just there to give us a powerful, extensible macro system.</p>
<p>The next step is to restore the player and centipede state. From the second round onwards this will have been modified by playing the game, so we need to initialise it to decent starting values.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   xor <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld [dead] <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ldVia <span class="dt">A</span> [segsLeft] numseg</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ldVia <span class="dt">HL</span> [plx] <span class="fu">$</span> coords (<span class="dv">15</span>, <span class="dv">20</span>)</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>xor</code> performs an XOR between whatever you pass it and the accumulator <code>A</code>, putting the result back in <code>A</code>. <code>xor A</code>, therefore, is just a really cheap way to set <code>A</code> to 0, since anything XOR’d with itself is 0.</p>
<p>We use this trick to set the <code>dead</code> state to 0, meaning that the player is alive. We also set the number of remaining segments to equal the total number of segments, restoring any that were destroyed in the previous round. Lastly, we put lambdaman in the player’s starting position, at the middle of the screen on the bottom row.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ld <span class="dt">HL</span> segmnt</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   decLoopB <span class="dv">10</span> <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [<span class="dt">HL</span>] <span class="dv">1</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- start off moving right.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">HL</span>    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [<span class="dt">HL</span>] <span class="dt">B</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- use B register as x coordinate.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">HL</span>    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [<span class="dt">HL</span>] <span class="dv">0</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- start at top.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">HL</span>    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Here we set the initial state of the segments, which may have been scattered around during the previous round. We make use of <code>decLoopB</code>, a macro which puts the number you pass it into the <em><code>B</code></em> register and then decrements it every iteration, using the Z80 <code>djnz</code> operation to drop out when it reaches 0.</p>
<p>The final bit of initialisation is to fill the play area with randomly scattered mushrooms.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   setAttrs <span class="dt">AttrTemp</span> <span class="dt">NoFlash</span> <span class="dt">Bright</span> (<span class="dt">Paper</span> <span class="dt">Black</span>) (<span class="dt">Ink</span> <span class="dt">Green</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   decLoopB <span class="dv">50</span> <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="dt">AT</span>   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- control code for AT character.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call random   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- get a &#39;random&#39; number.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="bn">0x0f</span>      </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- want vertical in range 0 to 15.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printA        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call random   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- want another pseudo-random number.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="bn">0x1f</span>      </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- want horizontal in range 0 to 31.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printA        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="bn">0x91</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- UDG &#39;B&#39; is the mushroom graphic.</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>First we set the attributes such that the <em><code>INK</code></em> is set to green, the colour of mushrooms the world over. Then we loop down from 50, placing mushrooms each iteration. The code looks complicated, but it’s actually quite simple: first we print the <em><code>AT</code></em> metacharacter which has to be followed by <em>y</em> and <em>x</em> co-ordinates, in that order. The co-ordinates, then, are randomly generated using the <code>random</code> function, which we’ll define later, and their range is limited using some binary arithmetic. We print those, and then finally print our mushroom sprite, which is UDG value <code>0x91</code>.</p>
<h2 id="the-main-loop">The main loop</h2>
<p>We’re now ready to run the main loop of our game! Traditionally, you would define a label here, and then put an unconditional jump to that label at the end of your loop, but we have a macro to do that:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   loopForever <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Here, “forever” is a bit of a stretch; naturally as this is assembly I can jump out of the loop to any other part of the program at any time – all the world’s a <code>GOTO</code>!</p>
<div class="sidenote">
<p>Astute readers may have noticed that I use <code>do</code> here instead of <code>mdo</code>. We don’t define any labels within this sub-block, or need to use those labels before their definition, so we don’t need to make use of recursive do. We get all the labels from the surrounding scope, which <em>is</em> recursive, regardless.</p>
</div>
<p>The main loop is mostly just a list of calls to other functions, which we’ll define below. The first thing we want to do every frame is delete the player sprite, so we can redraw it in its new position if it moved.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setCursorPos ([plx], [ply])</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call wspace</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Here we first set the cursor position to the player’s position, and then use <code>wspace</code> to draw a whitespace character at the current cursor position. We are now ready to handle input.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call input</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call vimput</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>I have two routines for input handling, though only one is necessary. The first uses the standard ZX Spectrum controls of Q, A, O, P and space, while the second uses vim-style controls of H, J, K, L, and enter. Both are always active, so you can play with whichever you prefer.</p>
<p>The above functions will have updated the player’s position if a move key was pressed. We are now ready to redraw the player at their current position.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setCursorPos ([plx], [ply])</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call splayr</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Again we set our co-ordinates to the player’s position, but this time instead of using <code>wspace</code> to draw an empty character we use <code>splayr</code> to draw the player sprite.</p>
<p>Next up is bullet handling. Rather than going into lots of detail here, I’ll just leave the inline comments intact. We’ll take a proper look at these functions later.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call bchk    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- check bullet position.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call defbull </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- delete bullets.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call moveb   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- move bullets.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call bchk    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- check new position of bullets.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call pbull   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- print bullets at new position.</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The last thing that needs updating is the centipede segments, which we delegate to the function <code>processSegments</code></p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call processSegments</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Finally, the end-of-frame handling. We put in an artificial delay because otherwise the game is unplayably fast:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     halt</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>And then we check our win/lose conditions. First, we check the <code>dead</code> flag to see if it is non-zero – if it is, we were killed so we should jump to the <code>gameOver</code> routine.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [dead]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jp <span class="dt">NZ</span> gameOver</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Otherwise, we see if the number of remaining centipede segments is zero – if it is, we killed the centipede, so we can go to <code>gameWon</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [segsLeft]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="dv">0</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jp <span class="dt">Z</span> gameWon</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>If neither of these is true, we are still playing, so we can simply loop. The <code>loopForever</code> macro handles this for us, so we can simply end the block here.</p>
<h2 id="handling-input">Handling input</h2>
<p>The following two routines handle input. I’m going to do the vim ones first because they demonstrate something quite interesting about how the ZX Spectrum keyboard works.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>    vimput <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      ld <span class="dt">BC</span> <span class="dt">KEYS_HJKLret</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- vim keys</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      in_ <span class="dt">A</span> [<span class="dt">C</span>]           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- see what keys are pressed.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"></code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"> </code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      rra                 </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- Enter to fire</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      push <span class="dt">AF</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- remember the value.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      call <span class="dt">NC</span> fire        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- it&#39;s being pressed, fire</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      pop <span class="dt">AF</span>              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- restore accumulator.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      rra                 </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- shift the next bit (l).</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      push <span class="dt">AF</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- remember the value.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      call <span class="dt">NC</span> mpr         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- it&#39;s being pressed, move right.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      pop <span class="dt">AF</span>              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- restore accumulator.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      rra                 </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- get the next bit (k).</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      push <span class="dt">AF</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- remember the value.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      call <span class="dt">NC</span> mpu         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- being pressed, so move up.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      pop <span class="dt">AF</span>              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- restore accumulator.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      rra                 </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- and the next bit (j)...</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      push <span class="dt">AF</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- remember the value.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      call <span class="dt">NC</span> mpd         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- being pressed, so move down.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      pop <span class="dt">AF</span>              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- restore accumulator.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      rra                 </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- finally, the next bit (h).</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      call <span class="dt">NC</span> mpl         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- it&#39;s being pressed, move left.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>      ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The keyboard on the Spectrum was divided into groups of five keys, which could be queried at once and each individual key accessed by checking one bit at a time from the resulting value. As it happens, H, J, K, L and enter formed one of these groups, so checking the vim keys can be done with a single query! We then just rotate the accumulator one bit at a time, calling the function to handle that particular bit of input each time that bit shows the key is pressed.</p>
<p>The standard Spectrum controls, Q, A, O, P, and space, are all from different groups on the keyboard, but they are generally the first or second key from that group, so although we have to do more queries, we don’t have to keep bitshifting the accumulator so much.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   input <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">BC</span> <span class="dt">KEYS_TREWQ</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     in_ <span class="dt">A</span> [<span class="dt">C</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rra</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call <span class="dt">NC</span> mpu</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">BC</span> <span class="dt">KEYS_GFDSA</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     in_ <span class="dt">A</span> [<span class="dt">C</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rra</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call <span class="dt">NC</span> mpd</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">BC</span> <span class="dt">KEYS_YUIOP</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     in_ <span class="dt">A</span> [<span class="dt">C</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rra</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     push <span class="dt">AF</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call <span class="dt">NC</span> mpr</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     pop <span class="dt">AF</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rra</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call <span class="dt">NC</span> mpl</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">BC</span> <span class="dt">KEYS_BNMsssp</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     in_ <span class="dt">A</span> [<span class="dt">C</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rra</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call <span class="dt">NC</span> fire</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>A real game would probably have user-mappable keys and much more complicated keyboard handling routines as a result, but for our purposes this is perfectly adequate.</p>
<h2 id="lambdaman">Lambdaman</h2>
<p>We’re ready to start defining the actual gameplay entities, beginning with our hero, the player – Lambdaman.</p>
<p>The following routine sets the cursor to the player position. It’s used to delete the character at the old position (by setting the cursor prior to moving the player, and drawing whitespace), and to draw the character into the new position (by setting the cursor after moving the player, and drawing the character).</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   basexy <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setCursorPos ([plx], [ply])</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Player drawing is done by the <code>splayr</code> routine. <code>0x90</code> here is ASCII code for User Defined Graphic ‘A’, which is where we put our lambdaman sprite right at the start.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   splayr <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setAttrs <span class="dt">AttrTemp</span> <span class="dt">NoFlash</span> <span class="dt">Bright</span> (<span class="dt">Paper</span> <span class="dt">Black</span>) (<span class="dt">Ink</span> <span class="dt">Cyan</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="bn">0x90</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The majority of player code is spent implementing the functionality enabled by the keyboard mappings above. First, though, we’re going to make a little utility function to check for the presence of a mushroom in the direction we want to move. Lambdaman can’t stand on top of mushrooms, so if there is a mushroom we want to return early – before we move the character.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">let</span> checkMushroom direction <span class="fu">=</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         <span class="kw">let</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">move <span class="dt">DLeft</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> dec <span class="dt">C</span>; </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">move <span class="dt">DRight</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> inc <span class="dt">C</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">move <span class="dt">DUp</span>    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> dec <span class="dt">B</span>; </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">move <span class="dt">DDown</span>  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> inc <span class="dt">B</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         ld <span class="dt">BC</span> [plx]     </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- current coords.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         move direction  </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- move to the position we want to check.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         call atadd      </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- address of attribute at this position.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         cp <span class="bn">0x44</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- mushrooms are bright green (0x44).</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>         ret <span class="dt">Z</span>           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- there&#39;s a mushroom - return early.</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The interesting thing to note here is that <code>checkMushroom</code> is a <em>Haskell</em> function, not a function in our program (i.e. a labelled block). What does this mean? Essentially, it acts like a macro in a traditional macro assembler – the code in the function will be generated at the call-site. Crucially, this means that the <code>ret Z</code> above doesn’t return from the function <code>checkMushroom</code> (there is no such function in the output assembly). Instead, it returns from the calling function. This, it turns out, is exactly what we want: to drop out of the calling function before the move has been enacted, in the case that the move would result in Lambdaman standing on a mushroom.</p>
<p>In case it’s not clear from looking at the code, the way we check for mushrooms is simply to poll the attributes of the character. If it’s green, we know it’s a mushroom, because there are no other green objects in the game. This extremely primitive approach to collision detection was actually quite common in early Spectrum games!</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   mpl <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> plx           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- plx is &quot;player x&quot;.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">HL</span>]           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- what&#39;s the current value?</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="dt">A</span>               </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- is it zero?</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span>               </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- yes - we can&#39;t go any further left.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     checkMushroom <span class="dt">DLeft</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- check for mushrooms.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dec [<span class="dt">HL</span>]            </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- decrement x position.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>OK, so here’s the first actual movement function, <code>mpl</code> (for “move player left”). The principle is fairly simple, and we’ll see this pattern repeated over the next few functions. The basic idea is to load the current value, check it’s not 0 (the very left of the screen), and return if it is, check there’s no mushroom there, and return if there is, and finally – if we’ve made it this far – decrement the player’s <span class="math inline">\(x\)</span> co-ordinate, thus moving it left.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   mpr <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> plx</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="dv">31</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     checkMushroom <span class="dt">DRight</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This function should look familiar. Instead of checking for 0, we compare against 31 – the rightmost column – and instead of decrementing we increment. Otherwise it’s basically the same. I could have extracted this pattern out into a helper function like I did with <code>checkMushroom</code>, but I actually found there were just enough differences that writing out the code for each case ended up being clearer than passing the parts which change as parameters to a function.</p>
<p>The following functions do the same for the up and down directions.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   mpu <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> ply</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="dv">0</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     checkMushroom <span class="dt">DUp</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dec [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   mpd <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> ply</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="dv">20</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     checkMushroom <span class="dt">DDown</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The only other routine left to define is missile firing. We keep this simple by only supporting one missile on screen at a time – that missile’s position is stored globally along with the player, as <code>pbx</code> and <code>pby</code> (player bullet x/y). When the missile is off-screen (i.e. there is no missile), we set the <span class="math inline">\(y\)</span> value to 255.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   fire <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">NZ</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> [plx]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dec <span class="dt">H</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [pbx] <span class="dt">HL</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We can check the existence of a missile by putting its <span class="math inline">\(y\)</span> position in a register and incrementing it. If it has position 255 it will wrap around to 0. If not, we know that it must be on the screen so we return early without spawning. To spawn the missile, we simply take the player’s position and increment the <span class="math inline">\(y\)</span> value, placing the missile immediately above the player.</p>
<h2 id="missiles">Missiles</h2>
<p>OK, so now the player’s fired a missile, we need to make it do something! Missiles move steadily up the screen, which can be achieved by simply decrementing the <span class="math inline">\(y\)</span> co-ordinate every frame the missile is on the screen. We first perform an increment to check whether the missile is on-screen. If not, we drop out immediately; if it is on-screen we subtract 2 – 1 to undo the increment we just performed and 1 more to actually move the missile. Finally, we load the register value back into <code>pby</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   moveb <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     sub <span class="dv">2</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [pby] <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Next, we need to handle collision detection between the missile and the mushrooms (we’ll deal with centipede collision in the next section). The <code>bchk</code> routine checks the position of the missile and, if it hits a mushroom, destroys it. We do this by first checking the <span class="math inline">\(y\)</span> co-ordinate to make sure there is a missile on screen at all, and if there is, checking the attribute at that location. If the character is green, that means it is a mushroom, so we can call the <code>hmush</code> function to destroy it. Otherwise, we simply return.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   bchk <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">BC</span> [pbx]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call atadd</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="bn">0x44</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> hmush</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>hmush</code> is very simple – we simply replace the character with whitespace and play the appropriate sound effect. We also set the missile’s <span class="math inline">\(y\)</span> position back to 255 to signify that it is “off screen”. This last step is done within the <code>kilbul</code> label, which we can jump to from elsewhere in the program, but as <code>hmush</code> contains no <code>ret</code> statement it will run straight from <code>call sfxHitM</code> to <code>ldVia A [pby] 0xff</code>. You can think of it like a fall-through case in C switch statements, if you like (since the labels in a switch statement are essentially <code>goto</code> labels, this is actually a pretty accurate way to think of it).</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   hmush <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setCursorPos ([pbx], [pby])</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call wspace</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call sfxHitM</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   kilbul <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ldVia <span class="dt">A</span> [pby] <span class="bn">0xff</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>To draw the missile, we follow the same pattern as when we drew the player. <code>bullxy</code> sets the cursor position to the current position of the missile (which might be off screen).</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   bullxy <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setCursorPos ([pbx], [pby])</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The <code>pbull</code> routine checks whether the missile is on screen, and if it is, prints the sprite <code>0x93</code>, or UDG ‘D’, at that location.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   pbull <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call bullxy</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="dt">INK</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="dt">YELLOW</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="bn">0x93</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We clear the missile using the <code>defbull</code> routine. This is as distinct from <code>kilbul</code>, which logically “kills” the bullet, by setting its position to 255; here we are deleting the bullet’s sprite from its current position on the screen, but not changing the location of the bullet within the game logic at all.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   defbull <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call bullxy</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>As with <code>kilbul</code> above, we run straight into the next function, <code>wspace</code>, to do the actual clearing of the sprite at the current position. This function is called from a number of places in code, but <code>defbull</code> has the advantage of being defined right next to it, so it can fall through to it without paying the cost of a function call.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   wspace <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setAttrs <span class="dt">AttrTemp</span> <span class="dt">NoFlash</span> <span class="dt">Bright</span> (<span class="dt">Paper</span> <span class="dt">Black</span>) (<span class="dt">Ink</span> <span class="dt">White</span>)</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="fu">$</span> chr <span class="ch">&#39; &#39;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Note that we set the colours to white-on-black. This may not seem important, since we’re drawing an empty space so there are no foreground (white) pixels to display – but remember, collision detection is done using colour attributes! If we left the colours as they were, the space would continue to act as an invisible missile, or mushroom, or whatever was there before!</p>
<h2 id="the-centipede">The centipede</h2>
<p>Next, we deal with the centipede. Being composed of a number of segments, the centipede is actually fairly complex – though by and large the segments work independently, even while they appear to be connected together. We begin with a helper routine, <code>segxy</code>, which performs the same job as <code>basexy</code> and <code>bullxy</code> above: it sets the cursor to the position of the current segment.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segxy <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setCursorPos ([<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>], [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>])</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Now that we have this, we want to go through each segment (of which there are ten) and process them, one by one. We do this using the trusty <code>decLoopB</code> macro we made use of earlier. Each segment contains three bytes: the segment’s current status, and its <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> co-ordinates. Current status has three possible values: 0 for “moving left”, 1 for “moving right”, and 255 to disable the segment once it’s been destroyed. The loop below goes through each segment and checks whether the status is 255 – if not, it runs <code>proseg</code> to process that segment, otherwise it skips over that and proceeds to the next one.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   processSegments <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">IX</span> segmnt        </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- table of segment data.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     decLoopB <span class="dv">10</span> <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       push <span class="dt">BC</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       ld <span class="dt">A</span> [<span class="dt">IX</span>]         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- is segment switched on?</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       inc <span class="dt">A</span>             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- 255=off  increments to zero.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       call <span class="dt">NZ</span> proseg    </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- it&#39;s active, so process segment.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       pop <span class="dt">BC</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       ld <span class="dt">DE</span> <span class="dv">3</span>           </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- 3 bytes per segment.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       add <span class="dt">IX</span> <span class="dt">DE</span>         </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- get next segment in ix registers.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The crux of the centipede’s processing code happens here, in <code>proseg</code>. As with the main loop, this is quite a high-level routine that delegates most of its actual processing to a few purpose-built routines, defined below.</p>
<p>We begin by calling <code>segcol</code> to check for collisions with this segment. If there was a collision, <code>segcol</code> will have turned off the segment, so we can check for that and drop out early if that’s happened. Otherwise, we clear the segment’s previous position, move the segment into its new position with <code>segmov</code>, and perform another collision check. Again, we need to check whether the segment was destroyed by the collision. If it wasn’t, we draw the UDG character ‘C’, which contains our segment graphic.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   proseg <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call segcol             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- segment collision detection</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span>]               </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- check if segment was switched off</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span>                   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- by collision detection routine.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span>                   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- it was  so this segment is now dead.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call segxy              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- set up segment coordinates.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call wspace             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- display a space  white ink on black.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call segmov             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- move segment.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call segcol             </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- new segment position collision check.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span>]               </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- check if segment was switched off</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span>                   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- by collision detection routine.</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span>                   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- it was  so this segment is now dead.</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call segxy              </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- set up segment coordinates.</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     setAttrs <span class="dt">AttrTemp</span> <span class="dt">NoFlash</span> <span class="dt">NotBright</span> (<span class="dt">Paper</span> <span class="dt">Black</span>) (<span class="dt">Ink</span> <span class="dt">Red</span>)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="bn">0x92</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The remaining functions therefore fall into two categories: segment movement, and collision detection and handling. We’ll deal with movement first.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segmov <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>] </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- x</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">C</span> <span class="dt">A</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>] </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- y</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">B</span> <span class="dt">A</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span>] </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- status</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> segml</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The segment is moving either left or right. We begin by loading the current co-ordinates into registers, and then checking which way it’s moving. If it’s moving left, we jump to the <code>segml</code> routine. If right, we fall through to the next routine, <code>segmr</code>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segmr <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="dv">31</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> segmd</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">C</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call atadd</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="bn">0x44</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> segmd</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The two movement routines are very similar. First we check if we’re at the edge of the screen, and if so jump to <code>segmd</code> to move down one line. If not, we check the attributes of the space one to the right, to see if there’s a mushroom there (Remember, mushrooms are bright green: <code>0x44</code>). Again, if there is we jump to <code>segmd</code>. If we passed both of these tests, there are no obstacles, so we can increment the <span class="math inline">\(x\)</span> position to move the segment to the right.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segml <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> segmd</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dec <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">C</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call atadd</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="bn">0x44</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> segmd</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dec [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>segml</code> is almost identical. We use <code>and A</code> again to check if we’re at the left edge.</p>
<p>Next, we define <code>segmd</code>, which the previous two routines used to move the segment down in the case of an obstacle or the edge of the screen.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segmd <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     xor <span class="dv">1</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [<span class="dt">IX</span>] <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp <span class="dv">20</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">Z</span> segmt</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Whenever the segment moves down, it should reverse direction, so that’s the first thing we do here. After that, we check if we’re at the bottom of the screen – if we are, we jump to <code>segmt</code> to move us back up to the top. Otherwise, we move down – regardless of whether there are any mushrooms or other obstacles in the way. This prevents a bug from happening whereby the mushrooms form a sort of “bucket” that can trap a segment.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segmt <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     xor <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>] <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This is the final movement function. All it does is to set the <span class="math inline">\(y\)</span> co-ordinate to 0. The <span class="math inline">\(x\)</span> co-ordinate will be wherever the segment was on the bottom line – usually the left or right edge, unless it happened to hit a mushroom.</p>
<p>Finally, we handle collision detection for centipede segments. We’ve already dealt with mushrooms, which cause the centipede to turn and move down the screen. The remaining items a segment could collide with are the player, killing him and scoring a point for the centipede, or the missile, which turns the segment into a mushroom and destroys the missile that hit it. First, the player.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   segcol <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [plx]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">NZ</span> bulcol</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [ply]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jr <span class="dt">NZ</span> bulcol</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>segcol</code> first compares the segment’s position with the player’s. If either the <span class="math inline">\(x\)</span> or the <span class="math inline">\(y\)</span> positions differ, it jumps to <code>bulcol</code> to try for missile collisions instead. If they are both the same, it falls through to the following routine, <code>killpl</code>, which sets the player’s <code>dead</code> flag.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   killpl <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [dead] <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Checking for a collision with the missile is similar to the collision check above – we simply compare <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> co-ordinates. If either of them is different we know there is no collision, so we can return.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   bulcol <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">Z</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp [<span class="dt">IX</span><span class="fu">+</span><span class="dv">2</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">NZ</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pbx]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     cp [<span class="dt">IX</span><span class="fu">+</span><span class="dv">1</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret <span class="dt">NZ</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>If we get this far, there has been a missile collision. We call <code>defbull</code> to delete the missile graphic, and then replace the segment’s own graphic with a mushroom. Finally, we call <code>kilbul</code> to “logically” kill the bullet, setting its <span class="math inline">\(y\)</span> co-ordinate to 255, and we also flag the segment as inactive. If there are still segments left, we play the “segment hit” sound effect, otherwise we don’t need to play any effect because the game over sound will play.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call defbull</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="dt">AT</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [pby]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printA</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal [pbx]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="dt">INK</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="dt">GREEN</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     printVal <span class="bn">0x91</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call kilbul</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [<span class="dt">IX</span>] <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> segsLeft</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dec [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     push <span class="dt">IX</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call <span class="dt">NZ</span> sfxHitC</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     pop <span class="dt">IX</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>And, that’s it for the centipede!</p>
<h2 id="utilities">Utilities</h2>
<p>There are a couple of utilities we’ve made use of in this game, both of which are taken from the same set of tutorials where I got most of the code for the rest of the game, but which would be useful in any game, not just this one. The first is a pseudo-random number generator which cleverly uses the Spectrum ROM itself as its source for randomness! It simply treats the seed as an offset into the ROM memory. You can see a fuller description on <a href="https://chuntey.wordpress.com/2013/02/28/how-to-write-zx-spectrum-games-chapter-4/">the original page</a>, but here’s the code.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   random <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> [seed]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> <span class="dt">H</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="dv">31</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">H</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc <span class="dt">HL</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld [seed] <span class="dt">HL</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   seed <span class="ot">←</span> labelled <span class="fu">$</span> defb [<span class="dv">0</span>,<span class="dv">0</span>]</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The other utility which has come up a lot is <code>atadd</code>, which calculates, from a pair of <span class="math inline">\((x, y)\)</span> co-ordinates, the location in memory for that co-ordinate’s attributes. This is extremely useful for polling co-ordinates for their attributes, which was the basis of all our collision detection. The original utility, with comments, can be seen <a href="https://chuntey.wordpress.com/2013/02/28/how-to-write-zx-spectrum-games-chapter-5/">here</a>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   atadd <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> <span class="dt">B</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rrca</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rrca</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     rrca</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">E</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="dv">3</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     add <span class="dt">A</span> <span class="dv">88</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">D</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> <span class="dt">E</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     and <span class="bn">0xe0</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">E</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> <span class="dt">C</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     add <span class="dt">A</span> <span class="dt">E</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">E</span> <span class="dt">A</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">A</span> [<span class="dt">DE</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ret</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="end-conditions">End conditions</h2>
<p>We’re just about ready to wrap up our game! The last thing remaining is to deal with the two end conditions – either the centipede killed Lambdaman, or Lambdaman killed the centipede. In either case, we play a sound effect, increase the appropriate score, and jump back to <code>gameStart</code> to begin the next round.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   gameOver <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call sfxLost</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> <span class="fu">$</span> centipedeScore <span class="fu">+</span> <span class="dv">1</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jp gameStart</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   gameWon <span class="ot">←</span> labelled <span class="fu">$</span> <span class="kw">do</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     call sfxWon</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     ld <span class="dt">HL</span> lambdamanScore</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inc [<span class="dt">HL</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     jp gameStart</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Out game is done, but because of the way labels work in <code>z80</code>, it is common for the last line in any program to be a variable definition (in this case <code>gameWon</code>). This, of course, is not allowed in Haskell, so <code>z80</code> defines <code>end</code> as an alias for <code>return ()</code>, giving us an expression to end on.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   end</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>With that, we can compile and run the program, which should spit out a file called <code>lambdaman.tap</code> which you can load into your favourite emulator.</p>

<div class="tagsinfo"><a href="/tags/haskell/index.html">haskell</a>, <a href="/tags/assembly/index.html">assembly</a>, <a href="/tags/z80/index.html">z80</a>, <a href="/tags/spectrum/index.html">spectrum</a>, <a href="/tags/literate-programs/index.html">literate-programs</a></div>
]]></summary>
</entry>
<entry>
    <title>Checking out old versions of files in git</title>
    <link href="http://dpwright.com/posts/2015/05/15/checking-out-old-versions-of-files-in-git/index.html" />
    <id>http://dpwright.com/posts/2015/05/15/checking-out-old-versions-of-files-in-git/index.html</id>
    <published>2015-05-15T11:36:27Z</published>
    <updated>2015-05-15T11:36:27Z</updated>
    <summary type="html"><![CDATA[

<div class="info">15 May, 2015</div>

<p>Here’s another useful alias if you’re using git. Sometimes you want to recover a file which has been deleted, or restore an old version of a single file. Or, you might want to grab a file from a different branch. This alias will let you do that:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"><span class="kw">[alias]</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"><span class="dt">    get-file </span><span class="ot">=</span><span class="st"> &quot;!f() { git show $</span><span class="dv">1</span><span class="st">:$</span><span class="dv">2</span><span class="st"> &gt; $</span><span class="dv">2</span><span class="co">; }; f&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Use it like this:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Get the version of README.md from commit 456e17b</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> get-file 456e17b README.md</code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"> </code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Get the version of foo.cpp from the &#39;stable&#39; branch</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> get-file stable path/to/foo.cpp</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Note that this will write the file out to its actual location (overwriting whatever’s there), so don’t run it if you have local modifications to that file, unless you don’t mind those modifications getting overwritten!</p>
<p>If you are using <a href="https://github.com/alebedev/git-media">git-media</a>, or something similar, you need to pipe the file through the filter. I set up another alias to do this:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"><span class="dt">    get-media </span><span class="ot">=</span><span class="st"> &quot;!f() { git show $</span><span class="dv">1</span><span class="st">:$</span><span class="dv">2</span><span class="st"> | git-media filter-smudge &gt; $</span><span class="dv">2</span><span class="co">; }; f&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>

<div class="tagsinfo"><a href="/tags/git/index.html">git</a>, <a href="/tags/alias/index.html">alias</a></div>
]]></summary>
</entry>
<entry>
    <title>Generating this website part 6</title>
    <link href="http://dpwright.com/posts/2015/05/02/generating-this-website-part-6-elastic-tabstops/index.html" />
    <id>http://dpwright.com/posts/2015/05/02/generating-this-website-part-6-elastic-tabstops/index.html</id>
    <published>2015-05-02T22:02:26Z</published>
    <updated>2015-05-02T22:02:26Z</updated>
    <summary type="html"><![CDATA[

<div class="info"> 2 May, 2015</div>

<div class="sidenote">
<p>This is part six of the “generating this website” series. To read the rest of the series, go to the series index <a href="http://www.dpwright.com/tags/generating%20this%20website">here</a></p>
</div>
<p>Over the New Year holidays this year I redesigned the site, incorporating a number of changes which (I hope) make it easier to read and nicer-looking to boot. These changes include:</p>
<ul>
<li>Removing most of the “link clutter” from the header, replacing it with just the title and a single <i class="fa fa-question-circle"></i> link, which takes you to an “about” page.</li>
<li>Pulling in the margins, putting the body of the article in a single, narrower column, which is easier for the readers’ eyes to track.</li>
<li>Changing the typefaces using a pair of fonts from Donald Knuth’s beautiful <span class="math inline">\(\LaTeX\)</span> typesetting system: <a href="http://en.wikipedia.org/wiki/Computer_Modern">Computer Modern</a> for the body and <a href="http://en.wikipedia.org/wiki/Concrete_Roman"><code>Concrete Roman</code></a> for preformatted/code blocks. The webfont versions of these fonts were downloaded from <a href="http://checkmyworking.com/cm-web-fonts/">this site</a>.</li>
</ul>
<p>The particularly perspicacious amongst you might have noticed an issue with this choice of typefaces, however. That is, <code>Concrete Roman</code> uses proportional spacing – it is <em>not</em> a monospaced font! And yet, all the code samples are aligned nicely. What dark magic is this?</p>
<h2 id="elastic-tabstops">Elastic tabstops</h2>
<p><a href="http://nickgravgaard.com/elastic-tabstops/">Elastic tabstops</a> were invented by Nick Gravgaard with the twin goals of ending the interminable tabs/spaces argument and allowing code to be lined up nicely even when using proportional fonts. The basic idea is simple – treat tabs not as a simple “jump to the next multiple of N” shortcut, but more as the delimiter of a table whose columns represent the layout you want your code to take. This animated GIF, taken from <a href="http://nickgravgaard.com/elastic-tabstops/">his website</a>, demonstrates the idea neatly:</p>
<center>
<img src="columnblocks_coloured.gif" title="Elastic tabstops demonstration" />
</center>
<p>Gravgaard had live editing in mind when he invented the concept, and has written plugins for a number of popular editors, however it applies just as well to static <em>display</em> of code, such as on a website. The implementation here simply does literally what the description of elastic tabstops says: it walks a Pandoc document looking for code blocks, and turns them into tables delimited by the tab.</p>
<p>Incidentally, there is nothing Hakyll-specific about this implementation – it is a post-process transformation on the Pandoc document. So it should support any of Pandoc’s output formats, in case you want to do something similar with your next LaTeX paper!</p>
<h2 id="preliminaries">Preliminaries</h2>
<p>The standard opening:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE UnicodeSyntax #-}</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></div></td>
</tr>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">ElasticTabstops</span> <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Prelude.Unicode</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Note I didn’t need to import <em><code>Hakyll</code></em>. We don’t use it here; this is pure Pandoc. We do need that though:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Text.Pandoc.Definition</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Text.Pandoc.Walk</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We’re also going to be doing some fiddling with lists, so we’ll import some utilities from <em><code>Data.List</code></em> and <em><code>Data.List.Split</code></em>.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.List</span>       </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(delete)</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.List.Split</span> </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(splitOn)</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="code-overview">Code overview</h2>
<p>We’re looking for a <em><code>Pandoc</code></em> <code>→</code> <em><code>Pandoc</code></em> transformation, which will walk through the tree and, if it finds a code block, “elasticate” it by transforming tabs into table columns. Seems simple enough:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; elasticTabstops ::</span> <span class="dt">Pandoc</span> <span class="ot">→</span> <span class="dt">Pandoc</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> elasticTabstops <span class="fu">=</span> walk <span class="fu">$</span> ifCodeBlock elasticate</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p><code>walk</code> actually expects a function which takes a <em><code>Block</code></em> and returns the transformed <em><code>Block</code></em>, so we define <code>ifCodeBlock</code> to run our function if the block is a <em><code>CodeBlock</code></em>, and just return it unmodified otherwise.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; ifCodeBlock ::</span> (<span class="dt">Attr</span> <span class="ot">→</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Block</span>) <span class="ot">→</span> <span class="dt">Block</span> <span class="ot">→</span> <span class="dt">Block</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> ifCodeBlock f (<span class="dt">CodeBlock</span> a s) </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> f a s</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> ifCodeBlock _ b               </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> b</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>The <code>elasticate</code> function, then, will take an <em><code>Attr</code></em> – the id, classes, and key-value pairs associated with a block – and a <em><code>String</code></em> representing the code itself, and return a new <em><code>Block</code></em>. We’ll wrap the generated “tables of code” in a <em><code>Div</code></em> with class <code>elastic-tabstops</code> in case we want to do any styling on it, or any further post-processing.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; elasticate ::</span> <span class="dt">Attr</span> <span class="ot">→</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Block</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> elasticate a s <span class="fu">=</span> <span class="dt">Div</span> ([], [<span class="st">&quot;elastic-tabstops&quot;</span>], []) <span class="fu">$</span> codeTables a s</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="grouping-the-code">Grouping the code</h2>
<p>Why “tables of code”, plural? Because in order to line the code up sensibly, we actually need to split it up into groups, and generate a separate table for each group. To see what I mean, take another look at the GIF above. If that code was all in one table, as the purple column got longer, the cyan column length would get longer with it! This would push the innermost block (<code>if (isPrime(i))</code> etc.) way further to the right than it needs to be.</p>
<p>To counteract this problem, we group the code based on the number of tabs in the line – consecutive lines containing the same number of tabs will be grouped together. We begin by defining a utility function to tell us the number of tabs in a line:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; countNumTabs ::</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Int</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> countNumTabs <span class="fu">=</span> length ∘ filter (<span class="fu">==</span> <span class="ch">&#39;\t&#39;</span>)</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We can consider a “group” to be a simple tuple containing the number of tabs in the lines in that group, and a list of the lines themselves:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">type</span> <span class="dt">CodeGroup</span> <span class="fu">=</span> (<span class="dt">Int</span>, [<span class="dt">String</span>])</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Our <code>group</code> function, then, is a simple fold over the lines in the code block, returning a list of these <em><code>CodeGroup</code></em>s.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; group ::</span> <span class="dt">String</span> <span class="ot">→</span> [<span class="dt">CodeGroup</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> group s <span class="fu">=</span> foldr groupMaker [] <span class="fu">$</span> lines s</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Given the definition of <code>foldr</code>, it is clear what the type of our <code>groupMaker</code> function needs to be. Because <code>foldr</code> associates to the right, you can consider it as if it’s working from the bottom of the code block upward. It’ll take the current line being processed, and the <em><code>CodeGroups</code></em> that have been identified so far, and return a new set of <em><code>CodeGroups</code></em> with the new line added appropriately.</p>
<p>What does “added appropriately” mean in this case? Well, there are two possibilities:</p>
<ul>
<li><em>If</em> there is a group already in the list (we are not on the first line), <em>and</em> the line under consideration has the same number of tabs as that group, add the line to that group.</li>
<li>Otherwise, create a new group containing only that line, and cons it to the list.</li>
</ul>
<p>This can be represented in Haskell thus:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; groupMaker ::</span> <span class="dt">String</span> <span class="ot">→</span> [<span class="dt">CodeGroup</span>] <span class="ot">→</span> [<span class="dt">CodeGroup</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> groupMaker l <span class="fu">=</span> go <span class="fu">$</span> countNumTabs l <span class="kw">where</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   go n ((n&#39;, ls)<span class="fu">:</span>gs) </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">|</span> n <span class="fu">==</span> n&#39; </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> (n, l<span class="fu">:</span>ls)<span class="fu">:</span>gs</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   go n gs            </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">          </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> (n, [l])<span class="fu">:</span>gs</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<h2 id="generating-the-tables-themselves">Generating the tables themselves</h2>
<p>Now we have all we need to split the code into groups, we can use those to construct the tables themselves. Before we start, we’ll set up a couple of utilities which will help set up the table.</p>
<p>Firstly, we want all columns to be left-aligned. We can do this by generating a list of <em><code>AlignLeft</code></em> of length one greater than the number of tabs. The tab character is the delimiter, so the number of columns will always be one greater than this.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; allLeft ::</span> <span class="dt">Int</span> <span class="ot">→</span> [<span class="dt">Alignment</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> allLeft n <span class="fu">=</span> replicate (n<span class="fu">+</span><span class="dv">1</span>) <span class="dt">AlignLeft</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Similarly, we need to specify the widths of the columns. We don’t need to be precise about this, and in fact it would be very complicated to try and work them out, and would require hard-coding the choice of typeface in here, which would be unfortunate. But we do need to specify <em>something</em>, otherwise the layout won’t be as predictable as we need it to be.</p>
<p>The trick is that we always want the right-most column to fill any excess space. This will force other columns to be as narrow as they can be, while still fitting the contained code. We can represent this as follows:</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; columnWidths ::</span> <span class="dt">Int</span> <span class="ot">→</span> [<span class="dt">Double</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> columnWidths n <span class="fu">=</span> replicate (n) <span class="dv">0</span> <span class="fu">++</span> [<span class="dv">1</span>]</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>Where a value of <code>0</code> means 0% and <code>1</code> means 100%.</p>
<p>Finally, we define <code>removeClass</code>, a utility to remove a certain class from a <em><code>Block</code></em>. Pandoc defines the <code>literate</code> class on Literate Haskell code blocks, which puts the leading <code>&gt;</code> at the beginning of lines – obviously we only want this in the first column of the table, so we need to remove <code>literate</code> from the attributes of subsequent columns.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; removeClass ::</span> <span class="dt">String</span> <span class="ot">→</span> <span class="dt">Attr</span> <span class="ot">→</span> <span class="dt">Attr</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> removeClass c (i, cs, kvs) <span class="fu">=</span> (i, delete c cs, kvs)</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>We are now ready to generate the actual tables. We begin by splitting the code into groups and making a table for each of those groups.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; codeTables ::</span> <span class="dt">Attr</span> <span class="ot">→</span> <span class="dt">String</span> <span class="ot">→</span> [<span class="dt">Block</span>]</code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> codeTables a <span class="fu">=</span> map (makeTable a) ∘ group</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>“Making a table” is itself a question of making a row for each line of code in the group, and wrapping that up in a Pandoc <em><code>Table</code></em> construct.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; makeTable ::</span> <span class="dt">Attr</span> <span class="ot">→</span> <span class="dt">CodeGroup</span> <span class="ot">→</span> <span class="dt">Block</span></code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> makeTable a (n, g) </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> constructTable <span class="fu">$</span> map makeRow g <span class="kw">where</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   constructTable   </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">Table</span> [] (allLeft n) (columnWidths n) []</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>To make a row, then, we split the line up based on the tab delimiter, then wrap it in a <em><code>CodeBlock</code></em> constructor. <em><code>CodeBlock</code></em> expects a set of attributes, so we pass the attributes of the original <em><code>CodeBlock</code></em> unchanged in the first column, and then pass a version with the <code>literate</code> class removed for all other columns. Finally we wrap the whole thing in a list.</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   makeRow </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> map (<span class="fu">:</span>[]) ∘ zipWith (<span class="fu">$</span>) codeRow ∘ splitOn <span class="st">&quot;\t&quot;</span></code></pre></div></td>
</tr>
<tr class="even">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   codeRow </code></pre></div></td>
<td align="left"><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> map <span class="dt">CodeBlock</span> <span class="fu">$</span> a<span class="fu">:</span>removeLiterates (repeat a)</code></pre></div></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   removeLiterates <span class="fu">=</span> map <span class="fu">$</span> removeClass <span class="st">&quot;literate&quot;</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>And that’s it! Beautifully aligned code, using a proportional font.</p>
<h2 id="epilogue">Epilogue</h2>
<p>There are a couple of issues with using elastic tabstops on this website.</p>
<p>Firstly, while Nick Gravgaard has written plugins for a number of editors, neither of the editors I use regularly (vim and emacs) are supported. This is for the very good reason that they <em>can’t</em> be – both of them use characters as their fundamental building block in terms of layout, so you can’t modify the layout by an arbitrary number of pixels.</p>
<p>As a result, I use a monospaced font when editing the posts and insert the tabs as I think appropriate. To see how that will actually affect the layout, I have to open the page in the browser, which is somewhat inconvenient. As well as that, I have apparently-superfluous tabs all over my file!</p>
<p>I have found that I get pretty good results by setting the tabstop length to 1, and making tabs visible. That way I can use spaces to align as usual, but use a tab as the last “space”. This looks good in my editor and also on the site, <em>and</em> I can see what’s going on thanks to the visible tabs.</p>
<p>Another issue is the way post previews come up in RSS feeds. The reader that I use, feedly, renders the tables representing my code quite badly – I end up with single-character columns with all the code written vertically! I think the solution to this is not to do the elastic tabstops transformation when generating the RSS feed, but I haven’t got around to this yet.</p>
<p>All in all, though, I’m pleased with the way it looks – and it’s a testament both to Haskell and to Pandoc’s design that it was so easy to add as a post-process to my site. There’s something lovely about the fact that the entry point to this entire blog post is a pure function with type <em><code>Pandoc</code></em> <code>→</code> <em><code>Pandoc</code></em>. No missiles being launched here!</p>

<div class="tagsinfo"><a href="/tags/hakyll/index.html">hakyll</a>, <a href="/tags/literate-programs/index.html">literate-programs</a>, <a href="/tags/generating%20this%20website/index.html">generating this website</a></div>
]]></summary>
</entry>

</feed>
