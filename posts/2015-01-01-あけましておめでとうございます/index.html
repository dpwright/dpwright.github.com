<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=650" />
        <title>Wright Access - あけましておめでとうございます</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css" />
        <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
    </head>
    <body>
        <div id="header">
            <div id="logo">
             <h1 id="logomain"><a href="../../">Wright Access.</a></h1>
            </div>
            <div id="navigation">
                <a href="../../pages/about.html"><i class="fa fa-question-circle"></i></a>
            </div>
        </div>

        <div id="content">
            
              <h1 class="title">あけましておめでとうございます</h1>
            
            

            <div class="info"> 1 January, 2015</div>



<center>
<img src="../../posts/2015-01-01-あけましておめでとうございます/nengajou.png" title="明けましておめでとうございます" />
</center>
<h2 id="年賀状をhaskellで">年賀状をHaskellで</h2>
<p>上の画像が今年の僕達の年賀状です。</p>
<p>実は、妻が最初アプリでデザインを考えていたのですが、 画像のダウンロードができず、Pixelmatorで作りなおそうという話がでました。 でも、これってHaskellでできるんじゃないの…？と思い、 試しにやってみることにしました。</p>
<p>５分の仕事が結局２日になったけど（笑）… 面白かったので、やり方を公開します。</p>
<h2 id="概要">概要</h2>
<p>まず、上の画像をみて、デザインを考えます。</p>
<p>最初は、下記のやりかたでやろうと思っていました。</p>
<ol style="list-style-type: decimal">
<li>写真の上に、真っ白のレイヤーを載せる。</li>
<li>その白いレイヤーから３つの三角形を切って、下の写真が見えるようになる。</li>
<li>最後にメッセージを追加する。</li>
</ol>
<p>ただ、diagramsでは、レイヤーを作って、そのレイヤーから切る機能がなかった （というか、あるかもしれないけど、僕が分からなかったので）。</p>
<p>結局、「上の白いレイヤーから切る」という方法ではなく、 「そのまま５つの三角形を描く」という方法でやりました。</p>
<p>文章ではちょっと分かりづらいと思うので、絵で説明します。</p>
<center>
<img src="../../posts/2015-01-01-あけましておめでとうございます/triangles.png" title="５つの三角形" />
</center>
<p>この下にメッセージをつけます。</p>
<p>では、実際にどう作ったか振り返ります。</p>
<h2 id="依存関係">依存関係</h2>
<p>まず、Haskellのライブラリをインストールします。</p>
<p>下記の<code>cabal</code>設定でインストールしました。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>executable nengajou2015</code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>  main-is:          </code></pre></td>
<td align="left"><pre><code>2015-01-01-happy-new-year.lhs</code></pre></td>
<td align="left"><pre><code></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>  build-depends:    </code></pre></td>
<td align="left"><pre><code>base                </code></pre></td>
<td align="left"><pre><code>&gt;= 4.7 &amp;&amp; &lt;4.8,</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>diagrams            </code></pre></td>
<td align="left"><pre><code>== 1.2,</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>diagrams-lib        </code></pre></td>
<td align="left"><pre><code>== 1.2.0.2,</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>diagrams-rasterific </code></pre></td>
<td align="left"><pre><code>== 0.1.0.1,</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>text                </code></pre></td>
<td align="left"><pre><code>== 1.1.1.3,</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>directory           </code></pre></td>
<td align="left"><pre><code>== 1.2.1.0,</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>filepath            </code></pre></td>
<td align="left"><pre><code>== 1.3.0.2,</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>process             </code></pre></td>
<td align="left"><pre><code>== 1.2.0.0,</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre><code>                    </code></pre></td>
<td align="left"><pre><code>SVGFonts            </code></pre></td>
<td align="left"><pre><code>== 1.4.0.3</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre><code>  default-language: </code></pre></td>
<td align="left"><pre><code>Haskell2010</code></pre></td>
<td align="left"><pre><code></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>arithmoi</code>は最近<code>llvm</code>のバージョンによってエラーになるときがあります。 その場合は、下記のコマンドで<code>cabal install</code>してください。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>$ cabal install --constrain &quot;arithmoi -llvm&quot;</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>フォントを<code>svg</code>に変換するため、<code>fontforge</code>が必要です。 Macを使ってたので、まず<a href="https://xquartz.macosforge.org/">XQuartz</a>をインストールしました。 それから、Homebrewで、</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre><code>$ brew install fontforge</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>を入力して、インストールします。</p>
<h2 id="予備">予備</h2>
<p><code>LANGUAGE</code>プラグマは、意外と多くなりました。 まず、いつもの<code>OverloadedStrings</code>と、 diagramsのドキュメンテーションに推奨される<code>NoMonomorphismRestriction</code>。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE NoMonomorphismRestriction #-}</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>NoMonomorphismRestriction</code>は使った方がいいと書いてあったので 入れましたが必要なかったので、結果的に使いませんでした。</p>
<p>フォントを設定するためのデータ構造では、 <code>Functor</code>と<code>Traversable</code>の関数を使いたいと思いました。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE DeriveFunctor #-}</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE DeriveFoldable #-}</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="ot">{-# LANGUAGE DeriveTraversable #-}</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>よっし！diagramsをインポートしよ！</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Diagrams.Prelude</span> <span class="kw">hiding</span> ((&lt;.&gt;))</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Diagrams.Backend.Rasterific.CmdLine</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>あ、テキストも書きたいからSVGFontsも必要になるね…</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Graphics.SVGFonts</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Graphics.SVGFonts.ReadFont</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>でも、SVGFontsを使うため、フォントをttfからsvgに変換しないと…</p>
<p>そのため、システム的なモジュールも必要だね…</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Directory</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.FilePath</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Process</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Exit</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>あ、きっとそのsvgファイルを調整しないとダメだろー</p>
<p><code>Data.Text</code>を使った方が最適…</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import qualified</span> <span class="dt">Data.Text</span>    </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">as <span class="dt">T</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import qualified</span> <span class="dt">Data.Text.IO</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">as <span class="dt">TIO</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>え、さっき<code>Traversable</code>って言わなかった？</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Foldable</span> (<span class="dt">Foldable</span>)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Traversable</span> <span class="kw">as</span> <span class="dt">TV</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>まだだよー</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Control.Arrow</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Control.Monad</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>まだだよー</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Char</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>終わり。</p>
<h2 id="型定義">型定義</h2>
<p>今回のプロジェクトは殆どの型はdiagramsで定義されています。</p>
<p>自分で定義をしたのは一つだけです。それは、フォントを設定するための型です。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">data</span> <span class="dt">Fonts</span> a </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="dt">Fonts</span></code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">{ english  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> a</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, numbers  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> a</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, japanese </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> a</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">} <span class="kw">deriving</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">(<span class="dt">Functor</span>, <span class="dt">Foldable</span>, <span class="dt">Traversable</span>)</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>「なぜ多相型で定義する必要があるの？」と思うかもしれませんが、 フォントは自動的に<code>.ttf</code>から<code>.svg</code>に変換できるようにしたいので、 同じストラクチャーで、ロードする前のファイル名と、 準備ができた使える状態のフォントを入れたいと思います。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">newtype</span> <span class="dt">PreparedFont</span> <span class="fu">=</span> <span class="dt">PreparedFont</span> {<span class="ot"> fromPF ::</span> <span class="dt">String</span> }</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>このnewtypeを使って、「フォントが変換された」と、型安全的に証明します。 （因みに最新版のSVGFontsでは<code>PreparedFont</code>は既に定義されているので、 最新版がHackageにアップされたらこれは必要なくなります。）</p>
<p>それでは、コード自体を始めましょう。</p>
<h2 id="二等辺三角形">二等辺三角形</h2>
<p>もう一度下の画像を見てみましょう。</p>
<center>
<img src="../../posts/2015-01-01-あけましておめでとうございます/triangles.png" title="５つの三角形" />
</center>
<p>この５つの三角形は全部二等辺三角形です！ diagramsは正三角形を作る関数が定義されていますが、 二等辺三角形はないため、自分で定義する必要があります。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; isosceles ::</span> <span class="dt">Angle</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> isosceles θ a <span class="fu">=</span> polygon (with <span class="fu">&amp;</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   polyType <span class="fu">.~</span> <span class="dt">PolySides</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   [ (<span class="dv">180</span> <span class="fu">@@</span> deg) <span class="fu">^-^</span> θ ]</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   [ legLength, legLength ]</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ) <span class="kw">where</span> legLength <span class="fu">=</span> a <span class="fu">/</span> cosA (θ<span class="fu">^/</span><span class="dv">2</span>)</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>θ</code>は頂角、<code>a</code>は高度（altitude）です。</p>
<p><code>(^-^)</code>、<code>(^/)</code>は<a href="https://hackage.haskell.org/package/vector-space">vector-space</a>というパッケージで定義され、 角度やベクトル等を引算、割算ができるような関数です。 意味が分からないときは<code>^</code>を消してみたら、だいたいの意味が見えてきます （<code>(^-^)</code> → <code>(-)</code>、<code>(^/)</code> → <code>(/)</code>)。</p>
<p><code>(&amp;)</code>、<code>(.~)</code>は<a href="https://hackage.haskell.org/package/lens">lens</a>のオペレーターです。 今からlensの説明しようとすると話が終わらないので、今日は省きます。</p>
<p>画像のレイアウトをするため、底辺の長さが必要なときがあります。 それを計算するために下記のユーティリティ関数を使います。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; isoscelesBase ::</span> <span class="dt">Angle</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> isoscelesBase θ a <span class="fu">=</span> <span class="dv">2</span> <span class="fu">*</span> tanA (θ<span class="fu">^/</span><span class="dv">2</span>) <span class="fu">*</span> a</code></pre></td>
</tr>
</tbody>
</table>
</div>
<h2 id="レイアウト">レイアウト</h2>
<p>簡単に言うと、このデザインは「上に画像があって、その下にメッセージ」と説明できます。</p>
<p>とりあえず、フォントや写真はもう既にロードされていると見なしましょう。 そうすると、下記のようになります。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; nengajou ::</span> <span class="dt">Fonts</span> <span class="dt">PreparedFont</span> <span class="ot">-&gt;</span> <span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span> <span class="ot">-&gt;</span> <span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> nengajou fs photo <span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">topImage θ photoShiftedRight <span class="st"># inViewport</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">===</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">message fs imageWidth (photoHeight <span class="fu">/</span> <span class="dv">3</span>)</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>(===)</code>は、２つの<em><code>Diagram</code></em>を上から下に並べる関数です。</p>
<p>分かりやすいでしょう！ <code>topImage</code>は上の画像、<code>message</code>は下のメッセージ。 並べると、年賀状になると。</p>
<p>あとは、ここで使った値を定義するだけです。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     θ                 </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">50</span> <span class="fu">@@</span> deg</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     photoHeight       </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">height photo</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     imageWidth        </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">isoscelesBase θ photoHeight</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>まずは、写真や画像についての変数です。<code>θ</code>の値を変更したら、三角形の形を変えられます。 <code>photoHeight</code>は写真全体の高さですが、 <code>imageWidth</code>はできた画像（緑のメイン三角形）の幅となります。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     photoShiftedRight </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">photo <span class="st"># translateX 40</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>実はもとの写真では人物は真ん中ではなかったので、 細かいことになりますが、これで調整しています。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     inViewport <span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">view </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">(p2 ((<span class="fu">-</span>imageWidth) <span class="fu">/</span> <span class="dv">2</span>, (<span class="fu">-</span>photoHeight) <span class="fu">/</span> <span class="dv">2</span>))</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">(r2 (imageWidth, photoHeight))</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>色が付いている三角形の画像をみると、ちょっと外側が汚いので、 <code>inViewport</code>で、外の部分を消す関数を用意しました。</p>
<h2 id="画像">画像</h2>
<p>画像自体も簡単に説明できます。まず、５つの三角形と合わせるため、 写真を切る必要があります。その切った写真の上に、三角形を載せていきます。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; topImage ::</span> <span class="dt">Angle</span> <span class="ot">-&gt;</span> <span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span> <span class="ot">-&gt;</span> <span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> topImage θ photo <span class="fu">=</span> triangles <span class="fu">&lt;&gt;</span> clippedPhoto <span class="kw">where</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>切るサイズは、写真の元の高さ✕緑の三角形の底辺の長さです。 それではちょっと幅が見えてしまうので、あと２ピクセルずつ、念の為に切ります。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   clippedPhoto </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> photo <span class="st"># clipBy (rect </span></code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">(centralTriangleBase <span class="fu">-</span> <span class="dv">2</span>)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">                       </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">(photoHeight <span class="fu">-</span> <span class="dv">2</span>))</code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   photoHeight         </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> height photo</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   centralTriangleBase </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> isoscelesBase θ photoHeight</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>triangles</code>は、左から右に言うと、</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   triangles </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> mconcat</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ edgeTriangleLeft</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, bottomTriangleLeft</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, centralTriangle</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, bottomTriangleRight</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, edgeTriangleRight</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">]</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>になります。この画像では順番は関係ないけれど、 場合によっては必要になりますね。 <em><code>Diagram</code></em>を連結すると、 上から下の順番になります（<code>edgeTriangleLeft</code>の下に <code>bottomTriangleLeft</code>を描いて、その下に <code>centralTriangle</code>を描く…という形）。</p>
<p>この画像の三角形を見ると２種類があります。 まずは、真ん中の３つの三角形。</p>
<center>
<img src="../../posts/2015-01-01-あけましておめでとうございます/outline-triangles.png" title="Picture of 3 central triangles goes here" />
</center>
<p>輪郭のみを描いて、下にある写真が見える三角形ですね。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   outlineTriangle a </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> isosceles θ a</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># centerXY</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># lc white</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># lw ultraThick</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>「なぜ<code>centerXY</code>が必要か？」ですが、Diagramsはデフォルトでは 原点は高度から見る真ん中ではなく、重心に設定してあります。 二等辺三角形を鏡映すると、ずれてしまう。 <code>centerXY</code>をしたら、簡単に鏡映できるようになります。</p>
<p>次は左と右の、真っ白の三角形です。</p>
<center>
<img src="../../posts/2015-01-01-あけましておめでとうございます/edge-triangles.png" title="Picture of 2 edge triangles goes here" />
</center>
<p>この三角形の頂角は真ん中の三角形の反対角度になっています。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   θ<span class="ch">' = (180 @@ deg) ^-^ θ</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>高度は下の三角形の底辺の半分です。 この値はまた使うので変数に保存しておきましょう。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   bottomTriangleHalfBase </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> centralTriangleBase <span class="fu">/</span> <span class="dv">4</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>あとは色と90°の回転です。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   edgeTriangle </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> isosceles θ<span class="ch">' bottomTriangleHalfBase</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># centerXY</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># lw none</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># fc white</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># rotate (90 @@ deg)</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>outlineTriangle</code>と<code>edgeTriangle</code>の２種類を定義できました。 これで５つの三角形が描けます。まずは真ん中の三角形です。 高度は写真と一緒です。その三角形を、<em>y</em> 軸に鏡映します。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   centralTriangle   </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> outlineTriangle photoHeight <span class="st"># reflectY</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>あとは右側の下の三角形と真っ白の三角形。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   bottomTriangleRight </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> outlineTriangle (photoHeight <span class="fu">/</span> <span class="dv">2</span>)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                       </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># translateY (-(photoHeight / 4))</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                       </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># translateX bottomTriangleHalfBase</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   edgeTriangleRight   </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> edgeTriangle</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                       </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># translateX (bottomTriangleHalfBase * 3 / 2)</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>最後は左側です。右側を、<em>x</em> 軸に鏡映するだけです。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   bottomTriangleLeft </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> reflectX bottomTriangleRight</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   edgeTriangleLeft   </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> reflectX edgeTriangleRight</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>画像の分はここまでです。</p>
<h2 id="メッセージ">メッセージ</h2>
<p>最初に「型は<em><code>Fonts</code></em>以外は定義しない」と言いましたが、 実は、メッセージを定義するため、今回下記のユーティリティー型を定義しました。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">data</span> <span class="dt">MessagePart</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="fu">=</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">MsgText</span>            </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   { </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">proportionalHeight </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> <span class="dt">Double</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">proportionalWidth  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> <span class="dt">Double</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">font               </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> <span class="dt">Fonts</span> <span class="dt">PreparedFont</span> <span class="ot">-&gt;</span> <span class="dt">PreparedFont</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">outline            </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> <span class="dt">Measure</span> <span class="dt">R2</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">msgText            </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> <span class="dt">String</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   } </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">                   </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="fu">|</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">MsgSpace</span>           </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   { </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">proportionalHeight </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">::</span> <span class="dt">Double</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   } </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">                   </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>この型はメッセージのDiagramを定義するための、一瞬の型なので、 絶対必要とは言えません。 正直、もともとこのプログラムを書いたときはこの型は使わず作りました。 ただ、あった方が絶対分かりやすいと思って、 ブログのためにちょっとリファクタリングしてみました。</p>
<p><em><code>MessagePart</code></em>はメッセージの一行です。 その一行はメッセージのテキスト（<em><code>MsgText</code></em>)か、 何も表記しない、ただスペース開けるため（<em><code>MsgSpace</code></em>）です。</p>
<p>この型について一つポイントがあります。 <code>proportionalHeight</code>と<code>proportionalWidth</code>は、「高さ」と「幅」の割合を意味します。 ただ、表記の仕方はそれぞれ違います。 <code>proportionalWidth</code>の方は、全体の幅に対しての割合ー 例えば、幅の半分としたいなら<code>1/2</code>と表記します。 一方、<code>proportionalHeight</code>は、表記スペースに対して一行の大きさを決るため、表記スペースに対するの「割合の分子」のみ表記します。 分母は、全部のメッセージの<code>proportionalHeight</code>の合計になるはずです。 結果、<em><code>MessagePart</code></em>を並べれば、スペースを１００％と使えていることになります。</p>
<p>この型があったらメッセージ自体は、ただ<em><code>MessagePart</code></em>のリストになります。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; messageParts ::</span> [<span class="dt">MessagePart</span>]</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> messageParts <span class="fu">=</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   [ <span class="dt">MsgSpace</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">6</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , <span class="dt">MsgText</span>  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">10</span> (<span class="dv">9</span> <span class="fu">/</span> <span class="dv">10</span>) english thin</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">(map toUpper <span class="st">&quot;Happy New Year&quot;</span>)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , <span class="dt">MsgSpace</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">1</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , <span class="dt">MsgText</span>  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">6</span> (<span class="dv">1</span> <span class="fu">/</span> <span class="dv">6</span>) numbers none <span class="st">&quot;2015&quot;</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , <span class="dt">MsgSpace</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , <span class="dt">MsgText</span>  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">4</span> (<span class="dv">33</span> <span class="fu">/</span> <span class="dv">40</span>) japanese none</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;昨年はお世話になりました　今年もよろしくお願いします&quot;</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   , <span class="dt">MsgText</span>  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dv">5</span> (<span class="dv">33</span> <span class="fu">/</span> <span class="dv">40</span>) english none</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>              </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">&quot;Wishing you a fantastic New Year, from Aki &amp; Dani&quot;</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   ]</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>では、このメッセージをどうやって<em><code>Diagram</code></em>に変換しましょう？</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; message ::</span> <span class="dt">Fonts</span> <span class="dt">PreparedFont</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> message fs w h <span class="fu">=</span> center messageText <span class="kw">where</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   messageText  <span class="fu">=</span> foldr1 (<span class="fu">===</span>) <span class="fu">.</span> map drawMsgPart <span class="fu">$</span> messageParts</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><em><code>MessagePart</code></em>を一つ一つ<code>drawMsgPart</code>で描いて、 それから<code>foldr1 (===)</code>で上から下まで並べます。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   drawMsgPart (<span class="dt">MsgSpace</span> ph)        </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> strut <span class="fu">$</span> r2 (<span class="dv">0</span>, getRealHeight ph)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   drawMsgPart (<span class="dt">MsgText</span> ph pw f o t) </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> text' (w <span class="fu">*</span> pw, getRealHeight ph) f o t</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><em><code>MsgSpace</code></em>だったら、ただ<em>y</em> 軸にスペースを開けます。 <em><code>MsgText</code></em>だったら<code>text'</code>としてレンダーします。</p>
<p><code>getRealHeight</code>は、割合の分子から、実際の高さに変換する関数です。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   getRealHeight ph </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> h <span class="fu">*</span> ph <span class="fu">/</span> totalHeight</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   totalHeight  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> sum <span class="fu">$</span> map proportionalHeight messageParts</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p><code>text'</code>は、SVGFontsを使ってテキストをレンダーします。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   text' (a, d) f o t </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> stroke (textPath t f a d)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                      </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st"># lw o # fc black &lt;&gt; strutY d</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   textPath t f a d </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> textSVG' <span class="fu">$</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">TextOpts</span> t (outlMap <span class="fu">.</span> fromPF <span class="fu">$</span> f fs)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                    </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">             </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">INSIDE_WH</span> <span class="dt">KERN</span> <span class="dt">False</span> a d</code></pre></td>
</tr>
</tbody>
</table>
</div>
<h2 id="不純なところ">不純なところ</h2>
<p>今までの関数は純粋的に定義しました。 これからは、実世界と繋がっている<code>IO</code>モナドを使って、 写真やフォントを準備するための関数を定義します。</p>
<p>写真は簡単です。Diagramsの<code>loadImageEmb</code>関数を呼んで、 エラーが返されたらそのまま出力して停止します。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; loadPhoto ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Diagram</span> <span class="dt">B</span> <span class="dt">R2</span>)</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> loadPhoto fp <span class="fu">=</span> either reportError (return <span class="fu">.</span> image) <span class="fu">=&lt;&lt;</span> loadImageEmb fp</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span> reportError err <span class="fu">=</span> putStrLn err <span class="fu">&gt;&gt;</span> exitWith (<span class="dt">ExitFailure</span> <span class="dv">1</span>)</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>フォントはもうちょっと複雑なんです。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; prepareFonts ::</span> <span class="dt">Fonts</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Fonts</span> <span class="dt">PreparedFont</span>)</code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> prepareFonts fs <span class="fu">=</span> <span class="kw">do</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">makeDirectory</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>                      </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">TV.sequence (fmap prepareFont fs) <span class="kw">where</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>フォントは<code>.ttf</code>から<code>.svg</code>に変換しないと使えないんです。 変換されたフォントは<code>svg-fonts</code>というディレクトリーに出力します。 まず、そのディレクトリーがない場合は作成しないとダメです。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   fontDir        </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;svg-fonts&quot;</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   makeDirectory  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="kw">do</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     dirExists <span class="ot">&lt;-</span> doesDirectoryExist fontDir</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     unless dirExists <span class="fu">$</span> createDirectory fontDir</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>変換自体はfontforgeを使って行います。 もしもう既に変換されたフォントがあるならまた変換する必要はありません。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   fontforge f f' </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> unwords [<span class="st">&quot;fontforge --lang=ff -c 'Open($1); Generate($2)'&quot;</span>, f, f']</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   prepareFont f  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="kw">do</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     <span class="kw">let</span> f' <span class="fu">=</span> fontDir <span class="fu">&lt;/&gt;</span> filter (<span class="fu">/=</span> <span class="ch">' '</span>) (takeBaseName f) <span class="fu">&lt;.&gt;</span> <span class="st">&quot;svg&quot;</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     fontAlreadyConverted <span class="ot">&lt;-</span> doesFileExist f'</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     unless fontAlreadyConverted <span class="fu">$</span> <span class="kw">do</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       system <span class="fu">$</span> fontforge f f'</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>       stripNamespaceLineFrom f'</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     return <span class="fu">$</span> <span class="dt">PreparedFont</span> f'</code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>fontforgeが出すXMLはネームスペースに入っていますが、 SVGFontsがネームスペース無しのXMLしかサポートされていません。 下記の関数はネームスペース宣言を外します。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; stripNamespaceLineFrom ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> stripNamespaceLineFrom f <span class="fu">=</span> TIO.readFile f <span class="fu">&gt;&gt;=</span> go</code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   <span class="kw">where</span> go </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span>   </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">T.words</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>            </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">&gt;&gt;&gt;</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">filter (not <span class="fu">.</span> T.isInfixOf <span class="st">&quot;xmlns&quot;</span>)</code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>            </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">&gt;&gt;&gt;</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">T.unwords</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>            </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">&gt;&gt;&gt;</span> </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">TIO.writeFile f</code></pre></td>
</tr>
</tbody>
</table>
</div>
<h2 id="main関数"><code>main</code>関数</h2>
<p>最後に、上記の関数を結んでいく<code>main</code>関数です。</p>
<p>写真とフォントの準備をし、<code>nengajou</code>の関数に渡して<em><code>Diagram</code></em>を作成します。 <code>pad</code>を使って枠を作ります。それから背景を白にしましょう。 最終、Diagramsの<code>mainWith</code>関数を使ってコマンドラインインターフェースが出来上がります。</p>
<div class="elastic-tabstops">
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; main ::</span> <span class="dt">IO</span> ()</code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> main <span class="fu">=</span> <span class="kw">do</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   photo <span class="ot">&lt;-</span> loadPhoto <span class="st">&quot;static/posts/2015-01-01-あけましておめでとうございます/beach-club.png&quot;</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   fonts <span class="ot">&lt;-</span> prepareFonts <span class="dt">Fonts</span></code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="0%" />
<col width="0%" />
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">{ english  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;/Library/Fonts/Microsoft/Garamond&quot;</span></code></pre></td>
</tr>
<tr class="even">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, numbers  </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;/Library/Fonts/Microsoft/Calisto MT&quot;</span></code></pre></td>
</tr>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>     </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell">, japanese </code></pre></td>
<td align="left"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">=</span> <span class="st">&quot;/Library/Fonts/Microsoft/ＤＦＰ教科書体W3&quot;</span> }</code></pre></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span>   mainWith <span class="fu">$</span> nengajou fonts photo <span class="st"># pad 1.1 # bg black</span></code></pre></td>
</tr>
</tbody>
</table>
</div>
<p>さあ、これで今年の年賀状が完成しました！</p>
<p>今年も楽しみながら、関数型言語で面白いものを作って行きましょう！</p>

<div class="tagsinfo">Tagged with: <a href="../../tags/%E6%97%A5%E6%9C%AC%E8%AA%9E/">日本語</a>, <a href="../../tags/functional-programming/">functional-programming</a>, <a href="../../tags/haskell/">haskell</a>, <a href="../../tags/%E3%81%8A%E6%AD%A3%E6%9C%88/">お正月</a>, <a href="../../tags/new%20year/">new year</a>, <a href="../../tags/%E5%B9%B4%E8%B3%80%E7%8A%B6/">年賀状</a></div>

        </div>
        <div id="footer">
          <div id="text-licence">
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Wright Access</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://dpwright.com/" property="cc:attributionName" rel="cc:attributionURL">Daniel P. Wright</a> is licensed under a<br />
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
          </div>
          <br />
          <div id="code-licence">
            All code is released under the <a href="../../pages/about.html#simplified-bsd-2-clause-license">BSD (2-Clause) License</a>.
          </div>
        </div>
    </body>
</html>
